name: RISK scan (incremental users_tzvira -> risk_reviews)

on:
  # אוטומטי: כל 10 דקות
  schedule:
    - cron: "*/10 * * * *"
  # ידני:
  workflow_dispatch:
    inputs:
      limit:
        description: "כמה שורות users_tzvira לסרוק בכל ריצה (ברירת מחדל 200)"
        required: false
        default: "200"
        type: string
      dry_run:
        description: "true = לא מכניס ל-risk_reviews ולא מעדכן watermark"
        required: false
        default: "false"
        type: string

permissions:
  contents: read

concurrency:
  group: risk-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      SUPABASE_URL: ${{ secrets.supabase_url }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      LIMIT: ${{ github.event.inputs.limit || '200' }}
      DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Ensure jq is available
        shell: bash
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
          jq --version

      - name: Validate required env
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_URL:-}" ]]; then
            echo "❌ Missing secret: supabase_url"; exit 1
          fi
          if [[ -z "${SUPABASE_KEY:-}" ]]; then
            echo "❌ Missing secret: SUPABASE_SERVICE_ROLE_KEY"; exit 1
          fi

      - name: Get watermark (risk_scan_state)
        id: state
        shell: bash
        run: |
          set -euo pipefail
          ENDPOINT="${SUPABASE_URL%/}/rest/v1/risk_scan_state"
          echo "GET $ENDPOINT (last_time_key)"

          RESP="$(curl -sS \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Accept: application/json" \
            -G "$ENDPOINT" \
            --data-urlencode "select=id,last_time_key" \
            --data-urlencode "order=id.asc" \
            --data-urlencode "limit=1" \
          )"
          echo "$RESP" > state.json

          ID="$(jq -r 'if type=="array" and length>0 then .[0].id else 1 end' state.json 2>/dev/null || echo 1)"
          LAST="$(jq -r 'if type=="array" and length>0 and .[0].last_time_key!=null then .[0].last_time_key else "1970-01-01T00:00:00Z" end' state.json 2>/dev/null || echo "1970-01-01T00:00:00Z")"

          echo "state_id=$ID" >> "$GITHUB_OUTPUT"
          echo "last_time_key=$LAST" >> "$GITHUB_OUTPUT"

      - name: Fetch risk_phrases
        shell: bash
        run: |
          set -euo pipefail
          ENDPOINT="${SUPABASE_URL%/}/rest/v1/risk_phrases"
          echo "GET $ENDPOINT"

          if ! curl -sS --fail-with-body \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Accept: application/json" \
            -G "${ENDPOINT}" \
            --data-urlencode "select=id,phrase,severity,enabled" \
            --data-urlencode "order=id.asc" \
            > phrases.json
          then
            echo "WARN: failed to fetch risk_phrases; using []"
            echo "[]" > phrases.json
          fi

          if ! jq -e . phrases.json >/dev/null 2>&1; then
            echo "WARN: invalid JSON for phrases; using []"
            echo "[]" > phrases.json
          fi

      - name: Fetch users_tzvira incrementally
        shell: bash
        run: |
          set -euo pipefail
          ENDPOINT="${SUPABASE_URL%/}/rest/v1/users_tzvira"
          LAST="${{ steps.state.outputs.last_time_key }}"
          echo "GET $ENDPOINT (time > $LAST), limit=$LIMIT"

          if ! curl -sS --fail-with-body \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Accept: application/json" \
            -G "$ENDPOINT" \
            --data-urlencode "select=time,phone,last_talk_tzvira" \
            --data-urlencode "time=gt.${LAST}" \
            --data-urlencode "order=time.asc" \
            --data-urlencode "limit=${LIMIT}" \
            > talks.json
          then
            echo "WARN: failed to fetch users_tzvira; using []"
            echo "[]" > talks.json
          fi

          if ! jq -e . talks.json >/dev/null 2>&1; then
            echo "WARN: invalid JSON for talks; using []"
            echo "[]" > talks.json
          fi

      - name: Build risk payload (Node)
        id: build_payload
        shell: bash
        run: |
          set -euo pipefail

          node scripts/risk_scan_build_payload.mjs \
            --talks talks.json \
            --phrases phrases.json \
            --out payload.json \
            --out-max-time max_time.txt \
            --context 80

          HITS="$(jq 'if type=="array" then length else 0 end' payload.json 2>/dev/null || echo 0)"
          MAXT="$(cat max_time.txt 2>/dev/null || true)"

          echo "hits=$HITS" >> "$GITHUB_OUTPUT"
          echo "max_time=$MAXT" >> "$GITHUB_OUTPUT"

      - name: Insert risk_reviews (ignore duplicates)
        if: ${{ steps.build_payload.outputs.hits != '0' && env.DRY_RUN != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          ENDPOINT="${SUPABASE_URL%/}/rest/v1/risk_reviews"
          echo "POST $ENDPOINT (Prefer: ignore-duplicates)"

          curl -sS --fail-with-body \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=ignore-duplicates" \
            -d @payload.json \
            "$ENDPOINT" >/dev/null

      - name: Update watermark (risk_scan_state.last_time_key)
        if: ${{ env.DRY_RUN != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          MAXT="${{ steps.build_payload.outputs.max_time }}"
          if [[ -z "${MAXT:-}" || "${MAXT}" == "1970-01-01T00:00:00Z" ]]; then
            echo "No max_time; skipping watermark update."
            exit 0
          fi

          ID="${{ steps.state.outputs.state_id }}"
          ENDPOINT="${SUPABASE_URL%/}/rest/v1/risk_scan_state"
          echo "UPSERT $ENDPOINT id=$ID last_time_key=$MAXT"

          curl -sS --fail-with-body \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "[{\"id\": ${ID}, \"last_time_key\": \"${MAXT}\"}]" \
            "$ENDPOINT" >/dev/null

      - name: Step summary (visible in run Summary tab)
        if: always()
        shell: bash
        run: |
          TALKS="$(jq 'if type=="array" then length else 0 end' talks.json 2>/dev/null || echo 0)"
          PHRASES="$(jq 'if type=="array" then length else 0 end' phrases.json 2>/dev/null || echo 0)"
          HITS="$(jq 'if type=="array" then length else 0 end' payload.json 2>/dev/null || echo 0)"
          LAST="${{ steps.state.outputs.last_time_key }}"
          MAXT="${{ steps.build_payload.outputs.max_time }}"
          {
            echo "## RISK scan – Summary"
            echo ""
            echo "- dry_run: ${DRY_RUN}"
            echo "- limit: ${LIMIT}"
            echo "- talks fetched: ${TALKS}"
            echo "- phrases fetched: ${PHRASES}"
            echo "- hits built: ${HITS}"
            echo "- last_time_key (before): ${LAST}"
            echo "- max_time (batch): ${MAXT}"
          } >> "$GITHUB_STEP_SUMMARY"
