
name: RISK scan (incremental users_tzvira -> risk_reviews)

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:
    inputs:
      limit:
        description: "Max rows per run"
        required: false
        default: "200"
      dry_run:
        description: "true = no inserts, no watermark update"
        required: false
        default: "false"

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate required env
        run: |
          test -n "${SUPABASE_URL}"
          test -n "${SUPABASE_KEY}"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Get watermark (risk_scan_state)
        run: |
          curl -sS \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            "${SUPABASE_URL%/}/rest/v1/risk_scan_state?key=eq.last_time_key&select=value" \
            | jq -r '.[0].value // "1970-01-01T00:00:00Z"' > watermark.txt
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Fetch risk_phrases
        run: |
          curl -sS \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            "${SUPABASE_URL%/}/rest/v1/risk_phrases?select=pattern,pattern_key,severity,is_active" \
            > phrases.json
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Fetch users_tzvira incrementally
        run: |
          WATERMARK=$(cat watermark.txt)
          curl -sS \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            "${SUPABASE_URL%/}/rest/v1/users_tzvira?select=id,created_at,content&created_at=gt.${WATERMARK}&order=created_at.asc&limit=${LIMIT}" \
            > users.json
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LIMIT: ${{ github.event.inputs.limit || '200' }}

      - name: Build risk payload (Node)
        run: |
          node <<'NODE'
          const fs = require('fs');
          const crypto = require('crypto');

          const phrases = JSON.parse(fs.readFileSync('phrases.json','utf8'));
          const users   = JSON.parse(fs.readFileSync('users.json','utf8'));

          const active = phrases.filter(p => p.is_active);
          const out = [];

          for (const u of users) {
            for (const p of active) {
              if (u.content && u.content.includes(p.pattern)) {
                out.push({
                  user_id: u.id,
                  pattern: p.pattern,
                  pattern_key: p.pattern_key,
                  severity: p.severity,
                  status: 'NEW',
                  matched_at: u.created_at
                });
              }
            }
          }

          fs.writeFileSync('payload.json', JSON.stringify(out, null, 2));
          console.log(`Prepared ${out.length} risk rows`);
          NODE

      - name: Insert risk_reviews (ignore duplicates, show body on error)
        run: |
          if [ "${DRY_RUN}" = "true" ]; then
            echo "DRY_RUN=true, skipping insert"
            exit 0
          fi

          ENDPOINT="${SUPABASE_URL%/}/rest/v1/risk_reviews"
          curl -sS --fail-with-body \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=ignore-duplicates" \
            -d @payload.json \
            "$ENDPOINT"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

      - name: Update watermark
        run: |
          if [ "${DRY_RUN}" = "true" ]; then
            echo "DRY_RUN=true, skipping watermark update"
            exit 0
          fi

          LAST=$(jq -r '.[-1].created_at' users.json)
          curl -sS \
            -X PATCH \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"value\":\"${LAST}\"}" \
            "${SUPABASE_URL%/}/rest/v1/risk_scan_state?key=eq.last_time_key"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

      - name: Step summary
        run: |
          echo "RISK scan completed" >> $GITHUB_STEP_SUMMARY
