name: List users_total pending names

on:
  workflow_dispatch: {}
  # אם תרצה מתוזמן, בטל הערות והגדר זמנים:
  # schedule:
  #   - cron: "5/10 * * * *"  # כל 10 דקות בשנייה 05, כדוגמתך

jobs:
  list:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      SUPABASE_URL: ${{ secrets.supabase_url }}
      SUPABASE_KEY: ${{ secrets.supabase_key }}

    steps:
      - name: Show runner info
        run: |
          echo "Runner: $RUNNER_OS"
          echo "Supabase URL len: ${#SUPABASE_URL}"

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
          jq --version

      - name: Query Supabase and print names
        run: |
          set -euo pipefail
          ENDPOINT="${SUPABASE_URL%/}/rest/v1/users_total"

          # סינון: התאמות מדויקות + וריאנטים לא-תלויי-רישיות עם ilike
          # (כולל "IN PROGRESS" עם רווח)
          curl -sS --fail \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Accept: application/json" \
            -G "$ENDPOINT" \
            --data-urlencode 'select=name,processed' \
            --data-urlencode 'or=(processed.eq.NEW,processed.eq.IN_PROGRESS,processed.eq."IN PROGRESS",processed.ilike.*new*,processed.ilike.*in*progress*)' \
            --data-urlencode 'order=created_at.desc' \
            | tee response.json \
            | jq -r '.[].name' \
            | nl -w2 -s'. ' || true

          # ספירת תוצאות
          COUNT=$(jq 'length' response.json)
          echo "COUNT=$COUNT" >> "$GITHUB_ENV"

      - name: Job summary
        run: |
          echo "### Names with processed in {NEW, IN_PROGRESS, IN PROGRESS}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${COUNT:-0}" = "0" ]; then
            echo "_No matching rows._" >> $GITHUB_STEP_SUMMARY
          else
            curl -sS --fail \
              -H "apikey: ${SUPABASE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_KEY}" \
              -H "Accept: application/json" \
              -G "${SUPABASE_URL%/}/rest/v1/users_total" \
              --data-urlencode 'select=name,processed' \
              --data-urlencode 'or=(processed.eq.NEW,processed.eq.IN_PROGRESS,processed.eq."IN PROGRESS",processed.ilike.*new*,processed.ilike.*in*progress*)' \
              --data-urlencode 'order=created_at.desc' \
              | jq -r '.[].name' \
              | nl -w2 -s'. ' >> $GITHUB_STEP_SUMMARY
          fi
