name: List users_total pending names

on:
  # ריצה כל 10 דק׳ בין 08:00–22:00 בישראל (UTC 6–20)
  schedule:
    - cron: "*/10 6-20 * * *"
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write
  workflows: write

concurrency:
  group: list-pending-users
  cancel-in-progress: false

jobs:
  list-and-trigger:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      SUPABASE_URL: ${{ secrets.supabase_url }}
      SUPABASE_KEY: ${{ secrets.supabase_key }}

    steps:
      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
          jq --version

      - name: Query Supabase (NEW/IN_PROGRESS/IN PROGRESS)
        id: query
        run: |
          set -euo pipefail
          ENDPOINT="${SUPABASE_URL%/}/rest/v1/users_total"

          curl -sS --fail \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Accept: application/json" \
            -G "$ENDPOINT" \
            --data-urlencode 'select=name,processed' \
            --data-urlencode 'or=(processed.eq.NEW,processed.eq.IN_PROGRESS,processed.eq."IN PROGRESS",processed.ilike.*new*,processed.ilike.*in*progress*)' \
            --data-urlencode 'order=created_at.desc' \
            | tee response.json

          COUNT=$(jq 'length' response.json)
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          echo "### Names with processed in {NEW, IN_PROGRESS, IN PROGRESS}" >> $GITHUB_STEP_SUMMARY
          jq -r '.[].name' response.json | nl -w2 -s'. ' >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total:** $(jq 'length' response.json)" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Run Landbot if count >= 1
        if: ${{ steps.query.outputs.count && fromJson(steps.query.outputs.count) >= 1 }}
        run: |
          echo "Found ${{ steps.query.outputs.count }} rows -> dispatching run-landbot-v2.yml"
          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/run-landbot-v2.yml/dispatches" \
            -d "{\"ref\":\"${{ github.ref_name }}\"}"
