name: Run Landbot (v2) via reusable workflow

on:
  workflow_call:
    inputs:
      lanbot_button_text:
        type: string
        required: false
        default: "×¡×™×›×•× ×©×™×—×•×ª ×”×ž×˜×•×¤×œ×™×"
      trigger_text:
        type: string
        required: false
        default: "×”×ª×—×œ ×¡×™×›×•× ×©×™×—×•×ª"
      expect_urls:
        type: string
        required: false
        default: "messages.landbot.io/webchat/api/send,welcome.landbot.io/webchat/auth"
      require_network_confirm:
        type: string
        required: false
        default: "false"
      headed:
        type: boolean
        required: false
        default: true
      post_action_idle_ms:
        type: string
        required: false
        default: "300000"
      supabase_wait_ms:
        type: string
        required: false
        default: "300000"
      force_min_run_seconds:
        type: string
        required: false
        default: "300"

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      NODE_ENV: production
      LANDBOT_URL: ${{ secrets.LANDBOT_URL }}
      SUPABASE_URL: ${{ secrets.supabase_url }}
      SUPABASE_KEY: ${{ secrets.supabase_key }}
      LANDBOT_BUTTON_TEXT: ${{ inputs.lanbot_button_text }}
      TRIGGER_TEXT: ${{ inputs.trigger_text }}
      EXPECT_URLS: ${{ inputs.expect_urls }}
      REQUIRE_NETWORK_CONFIRM: ${{ inputs.require_network_confirm }}
      HEADED: ${{ inputs.headed }}
      POST_ACTION_IDLE_MS: ${{ inputs.post_action_idle_ms }}
      SUPABASE_WAIT_MS: ${{ inputs.supabase_wait_ms }}
      FORCE_MIN_RUN_SECONDS: ${{ inputs.force_min_run_seconds }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          corepack enable
          if [ -f pnpm-lock.yaml ]; then
            corepack prepare pnpm@latest --activate
            pnpm i --frozen-lockfile
          elif [ -f package-lock.json ]; then
            npm ci
          else
            npm i
          fi

      - name: Install Playwright Browsers + deps
        run: npx playwright install --with-deps

      - name: Validate required env
        shell: bash
        run: |
          if [ -z "${LANDBOT_URL:-}" ]; then
            echo "::error::LANDBOT_URL secret is missing. Set it in Settings â†’ Secrets and variables â†’ Actions."
            exit 1
          fi

      - name: Echo effective settings
        shell: bash
        run: |
          {
            echo "LANDBOT_BUTTON_TEXT=${LANDBOT_BUTTON_TEXT}"
            echo "TRIGGER_TEXT=${TRIGGER_TEXT}"
            echo "EXPECT_URLS=${EXPECT_URLS}"
            echo "REQUIRE_NETWORK_CONFIRM=${REQUIRE_NETWORK_CONFIRM}"
            echo "HEADED=${HEADED}"
            echo "POST_ACTION_IDLE_MS=${POST_ACTION_IDLE_MS}"
            echo "SUPABASE_WAIT_MS=${SUPABASE_WAIT_MS}"
            echo "FORCE_MIN_RUN_SECONDS=${FORCE_MIN_RUN_SECONDS}"
          } | tee -a "$GITHUB_STEP_SUMMARY"

      - name: Run Landbot trigger (headed via Xvfb) + enforce min runtime
        shell: bash
        run: |
          set -u
          mkdir -p artifacts

          START_TS=$(date +%s)

          echo "HEADED=${HEADED}"
          if [ "${HEADED}" = "true" ] && command -v xvfb-run >/dev/null 2>&1; then
            xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" bash -lc 'node scripts/landbot_v2_trigger.mjs || true'
          else
            node scripts/landbot_v2_trigger.mjs || true
          fi

          END_TS=$(date +%s)
          DELTA=$(( END_TS - START_TS ))
          MIN_SECS=${FORCE_MIN_RUN_SECONDS:-300}

          echo "Run duration (so far): ${DELTA}s" | tee -a artifacts/_duration.txt

          if [ "$DELTA" -lt "$MIN_SECS" ]; then
            PAD=$(( MIN_SECS - DELTA ))
            echo "Padding runtime by ${PAD}s to reach at least ${MIN_SECS}s total..."
            sleep "$PAD"
          fi

          echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ') run finished" > artifacts/_runner_heartbeat.txt

      - name: Show Landbot message in summary
        if: always()
        shell: bash
        run: |
          set +e
          echo "## ðŸ¤– Landbot last message" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          if [ -f artifacts/bot_last_message.txt ]; then
            cat artifacts/bot_last_message.txt >> "$GITHUB_STEP_SUMMARY"
          else
            echo "[artifacts/bot_last_message.txt not found]" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f artifacts/bot_messages_all.txt ]; then
            echo "<details><summary>All bot messages (click)</summary>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            # ×–×” ×™×›×•×œ ×œ×”×™×•×ª ××¨×•×š. ×¢×“×™×™×Ÿ × ×•×—, ××‘×œ ×× ×–×” ×¢× ×§ â€“ ×ª×¨××” ×‘××¨×˜×™×¤×§×˜.
            head -c 200000 artifacts/bot_messages_all.txt >> "$GITHUB_STEP_SUMMARY" || true
            if [ "$(wc -c < artifacts/bot_messages_all.txt)" -gt 200000 ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "[TRUNCATED in summary â€“ full file in artifacts]" >> "$GITHUB_STEP_SUMMARY"
            fi
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "</details>" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: landbot-v2-artifacts-${{ github.run_id }}
          path: artifacts/**
          if-no-files-found: warn

      - name: Embed last screenshot in summary
        if: always()
        shell: bash
        run: |
          set +e
          if [ -f artifacts/screenshot_after.png ]; then
            B64=$(base64 -w 0 artifacts/screenshot_after.png)
            {
              echo "## Last screen (embedded)"
              echo ""
              echo "<img alt='after' src='data:image/png;base64,${B64}' width='100%' />"
              echo ""
              echo "_Full video & traces are attached as artifacts above._"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No screenshot_after.png to embed." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Job summary (links)
        if: always()
        shell: bash
        run: |
          set +e
          {
            echo "## Landbot v2 run (files)"
            if [ -f artifacts/_duration.txt ]; then
              echo ""
              echo "### Duration"
              cat artifacts/_duration.txt
              echo ""
            fi
            if [ -f artifacts/video.webm ]; then
              echo "- video: **video.webm** (see Artifacts)"
            fi
            if [ -f artifacts/trace.zip ]; then
              echo "- trace: **trace.zip** (see Artifacts)"
            fi
            if [ -f artifacts/msg_payload.json ]; then
              echo "- payload: **msg_payload.json** (see Artifacts)"
            fi
            if [ -f artifacts/bot_last_message.txt ]; then
              echo "- bot: **bot_last_message.txt** (see Artifacts)"
            fi
            if [ -f artifacts/bot_messages_all.txt ]; then
              echo "- bot: **bot_messages_all.txt** (see Artifacts)"
            fi
          } >> "$GITHUB_STEP_SUMMARY" || true
