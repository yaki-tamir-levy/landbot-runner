name: Run Landbot (v2)

on:
  # הופך את הקובץ ל-reusable workflow שניתן לקרוא אליו מ-Job אחר
  workflow_call:
    inputs:
      expect_urls:
        description: 'Comma-separated URL substrings to verify (e.g. messages.landbot.io/webchat/api/send,welcome.landbot.io/webchat/auth)'
        required: false
        type: string
      require_network_confirm:
        description: 'If true, fail when none of the expect_urls gets a 2xx response'
        required: false
        type: boolean
    secrets:
      LANDBOT_URL:
        required: true

permissions:
  contents: read

jobs:
  run:
    name: Landbot v2 runner
    runs-on: ubuntu-latest
    # אין timeout-minutes → ה-UI יציג "Running for …"
    env:
      LANDBOT_URL: ${{ secrets.LANDBOT_URL }}
      EXPECT_URLS: ${{ inputs.expect_urls || '' }}
      REQUIRE_NETWORK_CONFIRM: ${{ inputs.require_network_confirm && 'true' || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps (ci if lock exists, else install)
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Install Playwright (browsers & deps)
        run: npx playwright install --with-deps

      - name: Debug heartbeat
        run: date -Is > landbot_debug_started.txt

      - name: Run Landbot trigger (no shell timeout; watchdog inside script)
        run: |
          set -e
          npm run landbot-v2

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            landbot_before_click.png
            landbot_after_click.png
            landbot_fail.png
            landbot_page.html
            landbot_page_early.html
            landbot_error.txt
            landbot_debug_started.txt
            trace.zip
            videos/**
            landbot_run.webm
          if-no-files-found: warn
