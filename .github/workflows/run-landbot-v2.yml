name: Run Landbot (v2) via reusable workflow

# רץ רק כ-reusable
on:
  workflow_call:
    inputs:
      lanbot_button_text:
        required: false
        type: string
        default: "סיכום שיחות המטופלים"
      trigger_text:
        required: false
        type: string
        default: "התחל סיכום שיחות"
      expect_urls:
        required: false
        type: string
        default: "messages.landbot.io/webchat/api/send,welcome.landbot.io/webchat/auth"
      require_network_confirm:
        required: false
        type: string
        default: "false"
      headed:
        required: false
        type: boolean
        default: true
      # ⬇️ חדשים
      post_action_idle_ms:
        required: false
        type: string
        default: "45000"   # 45s
      supabase_wait_ms:
        required: false
        type: string
        default: "60000"   # 60s

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      NODE_ENV: production
      # סודות
      LANDBOT_URL: ${{ secrets.LANDBOT_URL }}
      SUPABASE_URL: ${{ secrets.supabase_url }}
      SUPABASE_KEY: ${{ secrets.supabase_key }}
      # פרמטרים
      LANDBOT_BUTTON_TEXT: ${{ inputs.lanbot_button_text }}
      TRIGGER_TEXT: ${{ inputs.trigger_text }}
      EXPECT_URLS: ${{ inputs.expect_urls }}
      REQUIRE_NETWORK_CONFIRM: ${{ inputs.require_network_confirm }}
      HEADED: ${{ inputs.headed }}
      # ⬇️ חדשים (נצרכים בסקריפט)
      POST_ACTION_IDLE_MS: ${{ inputs.post_action_idle_ms }}
      SUPABASE_WAIT_MS:    ${{ inputs.supabase_wait_ms }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          corepack enable
          if [ -f pnpm-lock.yaml ]; then
            corepack prepare pnpm@latest --activate
            pnpm i --frozen-lockfile
          elif [ -f package-lock.json ]; then
            npm ci
          else
            npm i
          fi

      - name: Install Playwright Browsers + deps
        run: npx playwright install --with-deps

      - name: Run Landbot trigger (headed via Xvfb)
        env:
          PW_HEADLESS: ${{ inputs.headed && '0' || '1' }}
        run: |
          mkdir -p artifacts
          if [ "${HEADED}" = "true" ]; then
            xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" \
              node scripts/landbot_v2_trigger.mjs || true
          else
            node scripts/landbot_v2_trigger.mjs || true
          fi
        shell: bash

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: landbot-v2-artifacts-${{ github.run_id }}
          path: artifacts/**
          if-no-files-found: warn

      - name: Job summary
        if: always()
        run: |
          {
            echo "## Landbot v2 run"
            [ -f artifacts/screenshot_before.png ] && echo "### Before" && echo "![before](./artifacts/screenshot_before.png)"
            [ -f artifacts/screenshot_highlight.png ] && echo "### Highlight" && echo "![highlight](./artifacts/screenshot_highlight.png)"
            [ -f artifacts/screenshot_after.png ]  && echo "### After"  && echo "![after](./artifacts/screenshot_after.png)"
            echo ""
            [ -f artifacts/msg_payload.json ] && echo "### msg_payload.json (first 1500 bytes)" && echo '```json' && head -c 1500 artifacts/msg_payload.json && echo && echo '```'
          } >> $GITHUB_STEP_SUMMARY
