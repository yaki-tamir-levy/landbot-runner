name: SUPA precheck (users_total.processed)

on:
  workflow_dispatch:
    inputs:
      limit:
        description: "×›××” ×©×•×¨×•×ª ×œ×”×¦×™×’ (×‘×¨×™×¨×ª ××—×“×œ 20)"
        required: false
        default: "20"
        type: string
      order_by:
        description: "(××•×¤×¦×™×•× ×œ×™) ×¡×“×¨ ××™×•×Ÿ ×œ××©×œ updated_at.desc"
        required: false
        type: string

permissions:
  contents: read
  actions: write

jobs:
  check-and-print:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure jq is available
        shell: bash
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Build REST URL (users_total, processed in NEW/IN_PROGRESS)
        id: build
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_URL:-}" ]]; then
            echo "âŒ Secret SUPABASE_URL ×—×¡×¨"; exit 1
          fi

          LIMIT="${{ github.event.inputs.limit }}"
          ORDER_BY="${{ github.event.inputs.order_by }}"

          BASE="${SUPABASE_URL%/}/rest/v1/users_total"
          QS="select=name,processed&limit=${LIMIT}"
          QS="${QS}&processed=in.(NEW,IN_PROGRESS)"
          if [[ -n "${ORDER_BY}" ]]; then
            QS="${QS}&order=${ORDER_BY}"
          fi

          echo "url=${BASE}?${QS}" >> "$GITHUB_OUTPUT"

      - name: Query Supabase and print field values (name + processed)
        id: query
        shell: bash
        env:
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_KEY:-}" ]]; then
            echo "âŒ Secret SUPABASE_KEY ×—×¡×¨"; exit 1
          fi

          URL="${{ steps.build.outputs.url }}"
          echo "ğŸ” GET $URL"

          RESP="$(curl -sS \
            -H 'apikey: '"$SUPABASE_KEY" \
            -H 'Authorization: Bearer '"$SUPABASE_KEY" \
            -H 'Accept: application/json' \
            "$URL")"

          echo "----- JSON ×’×•×œ××™ -----"
          echo "$RESP"
          echo "-----------------------"

          COUNT="$(printf '%s' "$RESP" | jq 'length')"
          echo "ğŸ“Š × ××¦××• ${COUNT} ×©×•×¨×•×ª ×¢× processed ×‘- {NEW, IN_PROGRESS}"

          # ×—×•×©×¤×™× count ×œ-steps ×”×‘××™×
          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"

          if [[ "$COUNT" -gt 0 ]]; then
            echo "ğŸ”” ×—×œ×•×§×” ×œ×¤×™ ×¢×¨×š:"
            printf '%s' "$RESP" | jq -r '.[].processed' | sort | uniq -c

            echo ""
            echo "ğŸ§¾ ×¤×™×¨×•×˜ (name â†’ processed):"
            printf '%s' "$RESP" | jq -r '.[] | "\(.name) â†’ \(.processed)"'

            {
              echo "### SUPA precheck â€“ users_total (processed in NEW/IN_PROGRESS)"
              echo ""
              echo "**Count:** ${COUNT}"
              echo ""
              echo "| name | processed |"
              echo "|---|---|"
              printf '%s' "$RESP" | jq -r '.[] | ["\(.name)","\(.processed)"] | @tsv' \
                | while IFS=$'\t' read -r NAME PROC; do
                    echo "| ${NAME} | ${PROC} |"
                  done
            } >> "$GITHUB_STEP_SUMMARY"

            echo "::notice title=SUPA precheck::found ${COUNT} rows (processed in NEW/IN_PROGRESS)"
          else
            echo "â„¹ï¸ ×œ× × ××¦××• ×©×•×¨×•×ª ××ª××™××•×ª."
            echo "::notice title=SUPA precheck::no rows found"

            {
              echo "### SUPA precheck â€“ users_total"
              echo ""
              echo "No rows found (processed in NEW/IN_PROGRESS)."
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Trigger RUN USERS_TOTAL now
        if: ${{ steps.query.outputs.count != '0' }}
        uses: peter-evans/workflow-dispatch@v2
        with:
          # ××¤×¢×™×œ ×œ×¤×™ name ×©×œ ×”-workflow ×”×¨××©×™
          workflow: RUN USERS_TOTAL
          ref: main
          inputs: |
            {}

      - name: Skip note (no pending rows)
        if: ${{ steps.query.outputs.count == '0' }}
        run: echo "â­ï¸ ××™×Ÿ ×©×•×¨×•×ª ××ª××™××•×ª â€“ ×”-Workflow ×”×¨××©×™ ×œ× ×”×•×¤×¢×œ."
