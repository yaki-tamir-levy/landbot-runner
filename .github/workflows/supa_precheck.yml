name: SUPA precheck (users_total.processed)

on:
  # ××•×˜×•××˜×™: ×›×œ 15 ×“×§×•×ª ×¢×’×•×œ×•×ª (UTC)
  #schedule:
  #  - cron: "*/15 * * * *"
  # ×™×“× ×™:
  workflow_dispatch:
    inputs:
      limit:
        description: "×›××” ×©×•×¨×•×ª ×œ×”×¦×™×’ (×‘×¨×™×¨×ª ××—×“×œ 20)"
        required: false
        default: "20"
        type: string
      order_by:
        description: "(××•×¤×¦×™×•× ×œ×™) ×¡×“×¨ ××™×•×Ÿ ×œ××©×œ updated_at.desc"
        required: false
        type: string
      max_runs:
        description: "×ª×§×¨×ª ×‘×˜×™×—×•×ª ×œ×”×¤×¢×œ×•×ª RUN_USERS_TOTAL (×‘×¨×™×¨×ª ××—×“×œ 5)"
        required: false
        default: "5"
        type: string

permissions:
  contents: read
  actions: write

# ×›×“×™ ×©×œ× ×™×¦×˜×‘×¨×• ×›××” precheck ×‘××§×‘×™×œ
concurrency:
  group: supa-precheck-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-and-trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure jq is available
        shell: bash
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Build REST URL (users_total, processed in NEW/IN_PROGRESS)
        id: build
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_URL:-}" ]]; then
            echo "âŒ Secret SUPABASE_URL ×—×¡×¨"; exit 1
          fi
          LIMIT="${{ github.event.inputs.limit || '20' }}"
          ORDER_BY="${{ github.event.inputs.order_by || '' }}"
          BASE="${SUPABASE_URL%/}/rest/v1/users_total"
          QS="select=name,processed&limit=${LIMIT}&processed=in.(NEW,IN_PROGRESS)"
          if [[ -n "${ORDER_BY}" ]]; then QS="${QS}&order=${ORDER_BY}"; fi
          echo "url=${BASE}?${QS}" >> "$GITHUB_OUTPUT"

      - name: Query Supabase (count & list)
        id: query
        shell: bash
        env:
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_KEY:-}" ]]; then
            echo "âŒ Secret SUPABASE_KEY ×—×¡×¨"; exit 1
          fi
          URL="${{ steps.build.outputs.url }}"
          echo "ğŸ” GET $URL"
          RESP="$(curl -sS -H "apikey: $SUPABASE_KEY" -H "Authorization: Bearer $SUPABASE_KEY" -H "Accept: application/json" "$URL")"
          echo "----- JSON ×’×•×œ××™ -----"; echo "$RESP"; echo "-----------------------"
          COUNT="$(printf '%s' "$RESP" | jq 'length')"
          echo "ğŸ“Š × ××¦××• ${COUNT} ×©×•×¨×•×ª ×¢× processed ×‘-{NEW, IN_PROGRESS}"
          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
          if [[ "$COUNT" -gt 0 ]]; then
            echo "ğŸ§¾ ×¤×™×¨×•×˜ (name â†’ processed):"
            printf '%s' "$RESP" | jq -r '.[] | "\(.name) â†’ \(.processed)"'
          else
            echo "â­ï¸ ××™×Ÿ ×©×•×¨×•×ª ××ª××™××•×ª."
          fi

      - name: Trigger RUN USERS_TOTAL N times (queued by concurrency)
        if: ${{ steps.query.outputs.count != '0' }}
        uses: actions/github-script@v7
        env:
          FOUND_COUNT: ${{ steps.query.outputs.count }}
          MAX_RUNS: ${{ github.event.inputs.max_runs || '5' }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const WORKFLOW_FILE = ".github/workflows/find-pending-users.yml"; // ×¢×“×›×Ÿ ×× ×¦×¨×™×š
            const found = parseInt(process.env.FOUND_COUNT || "0", 10);
            const cap   = parseInt(process.env.MAX_RUNS || "5", 10);
            const times = Math.min(found, cap);
            core.notice(`Dispatching RUN USERS_TOTAL ${times} time(s) (found=${found}, cap=${cap})`);
            for (let i = 1; i <= times; i++) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: WORKFLOW_FILE,
                ref: "main",
                inputs: {}
              });
              core.info(`â†’ Dispatched #${i}/${times}`);
            }

      - name: Step summary
        run: |
          echo "### SUPA precheck â€“ Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Found count: ${{ steps.query.outputs.count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Max runs cap: ${{ github.event.inputs.max_runs || '5' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Triggered workflow file: \`.github/workflows/find-pending-users.yml\`" >> "$GITHUB_STEP_SUMMARY"
