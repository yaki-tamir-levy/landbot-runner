name: Render OTP test page (from secrets)
 
on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: render-otp-test
  cancel-in-progress: false

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "Missing secret: SUPABASE_URL" >&2
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_KEY }}" ]; then
            echo "Missing secret: SUPABASE_KEY (expected ANON key, not service role)" >&2
            exit 1
          fi

      - name: Render otp_test.html (root and /docs)
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          set -euo pipefail

          if [ ! -f "otp_test.template.html" ]; then
            echo "Missing otp_test.template.html in repo root" >&2
            exit 1
          fi

          render() {
            local out="$1"
            mkdir -p "$(dirname "$out")"
            sed               -e "s|__SUPABASE_URL__|${SUPABASE_URL}|g"               -e "s|__SUPABASE_ANON_KEY__|${SUPABASE_ANON_KEY}|g"               "otp_test.template.html" > "$out"
          }

          render "otp_test.html"
          render "docs/otp_test.html"

          # Basic sanity check
          grep -q "${SUPABASE_URL}" "otp_test.html"
          grep -q "${SUPABASE_URL}" "docs/otp_test.html"

      - name: Commit generated pages
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add otp_test.html docs/otp_test.html
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update otp_test.html from secrets [skip ci]"
          git push
