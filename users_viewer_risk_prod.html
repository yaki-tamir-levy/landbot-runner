<!doctype html>
<html lang="he" dir="rtl">
<head>
  <script>
<script>
  (function () {
    // אותה הסיסמה כמו בקובץ launcher.html
    const APP_PASSWORD   = "yon1234";
    const EXPECTED_TOKEN = "ok-" + btoa(APP_PASSWORD);

    try {
      const token = sessionStorage.getItem("riskAppAuth");

      // אם אין טוקן תקין – מחזירים למסך הכניסה
      if (token !== EXPECTED_TOKEN) {
        window.location.href = "launcher.html";
        return;
      }

      // אם הגענו לכאן – הטוקן תקין עבור הכניסה הנוכחית.
      // מנקים אותו מיד כדי שכל טעינה מחדש תדרוש סיסמה מחדש.
      sessionStorage.removeItem("riskAppAuth");
    } catch (e) {
      window.location.href = "launcher.html";
    }
  })();
</script>
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>השיחות של המטפל הוירטואלי</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.js"></script>
  <style>
    :root { --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --divider:#e5e7eb; --danger:#7f1d1d; --ok:#065f46; --hi:#fde68a; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1000px;margin:0 auto;padding:20px}
    h2{margin:0 0 12px 0; text-align:center}

    .card{background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:var(--muted)}
    input,button,select{background:#fff;color:var(--ink);border:1px solid var(--divider);border-radius:10px;padding:8px 10px}
    input::placeholder{color:#9ca3af}
    button{cursor:pointer}
    .controls{margin-bottom:10px}
    .table{margin-top:12px;display:flex;flex-direction:column;gap:10px}

    .talk{border:1px solid var(--divider);border-radius:12px;overflow:hidden;background:#fff}

    .head{
      display:grid;
      grid-template-columns:auto auto 140px 140px 160px auto 150px;
      align-items:center;
      gap:8px;
      background:#fafafa;
      padding:10px 12px;
      border-bottom:1px solid #e5e7eb
    }

    .patient-name{font-weight:900;font-size:1.35rem;}
    .patient-phone{font-weight:400;font-size:0.9rem;color:var(--muted);}

    .btn-toggle,
    .btn-summarized_linked_talk,
    .btn-raw-summary,
    .btn-home{
      font-weight:700; border:2px solid #d1d5db; border-radius:10px; padding:8px 10px; background:#fff; min-width:140px; text-align:center
    }
    .btn-home{font-weight:400; min-width:150px; border-width:1px}
    .btn-selected{
      background:#f3e8ff !important;
      border-color:#e9d5ff !important;
    }

    .btn-placeholder{
      display:inline-block;
      visibility:hidden;
      font-weight:700;
      border-radius:1rem;
      padding:8px 10px;
      min-width:140px;
      text-align:center;
    }

    .btn-state-active{ background:#dcfce7; border-color:#bbf7d0; }
    .btn-state-locked{ background:#e5e7eb; border-color:#d1d5db; cursor:not-allowed; }

    .btn-summarized_linked_talk[disabled]{opacity:.55; cursor:not-allowed}
    .btn-toggle:hover,.btn-summarized_linked_talk:hover,.btn-raw-summary:hover{box-shadow:0 0 0 2px #e5e7eb inset}

    .meta{color:var(--muted);font-weight:600}

    .body{padding:12px;white-space:pre-wrap;line-height:1.55}
    .summarized_linked_talk{padding:12px; white-space:pre-wrap; line-height:1.6; background:#fffaf0; border-top:1px dashed #f1d29b; display:none}
    .summarized_linked_talk .empty{color:#9ca3af}

    .hint{color:#6b7280;font-size:12px}
    .counts{margin-top:6px}

    mark.risk{ background:#ffe4e6; color:#000; padding:0 3px; border-radius:4px; font-weight:900; font-size:1.08em; }
    mark.risk.reviewed{ background:#d1fae5; color:#065f46; }

    .alertbar{border:1px solid #fecaca;background:#fee2e2;border-radius:12px;padding:10px 12px;margin:0 0 10px}
    .alertbar h3{margin:0 0 6px 0;color:#7f1d1d;font-size:14px}
    .alertitem{margin:6px 0;padding:8px 10px;border-radius:8px;background:#fff;border:1px dashed #fecaca}
    .alertitem .when{color:#7f1d1d;font-weight:700}

    .pill{ display:inline-block; padding:6px 12px; border-radius:999px; background:#ffe4e6; color:#000; font-size:16px; margin:2px 6px 2px 0; font-weight:900; border:1px solid #fecaca }
    .btn-open-risk{ font-weight:900; background:#ffd1d6; border:2px solid #fca5a5; padding:6px 12px; border-radius:10px; }
    .btn-open-risk:hover{ filter:brightness(0.98) }

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .speaker{white-space:pre-wrap}
    .speaker-patient{font-weight:700}
    .speaker-therapist{font-weight:800;font-style:italic;font-size:1.05em}
    .line-spacer{height:1em}

    .target-blink{animation: blink 1.3s ease-in-out 1}
    @keyframes blink{ 0%{background:var(--hi)} 100%{background:transparent} }

    #statusBar{margin:10px 0}
    #statusBar .err{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:10px;border-radius:10px}

    .inline-msg{margin:8px 12px;background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:8px 10px;border-radius:10px}
    .note-yellow{background:var(--hi); padding:0 4px; border-radius:4px}
    .btn-review-inline,.btn-unreview-inline{margin-inline-start:8px}
  </style>
</head>
<body>
<div class="wrap">
  <h2>השיחות של המטפל הוירטואלי</h2>

  <div id="statusBar"></div>
  <div id="alertHost"></div>

  <div class="card controls">
    <div class="row">
      <div><label>Phone<br /><input id="fPhone" placeholder="+9725..." /></label></div>
      <div><label>Name<br /><input id="fName" placeholder="שם" /></label></div>
      <div><label>From (YYYY.MM.DD)<br /><input id="fFrom" placeholder="2025.11.01" /></label></div>
      <div><label>To (YYYY.MM.DD)<br /><input id="fTo" placeholder="2025.11.30" /></label></div>
      <div>
        <label>בחר סטטוס מטופל<br />
          <select id="fKind">
            <option value="" selected>הכל</option>
            <option value="1">מטפל וירטואלי</option>
            <option value="2">מדריך קורס</option>
            <option value="3">מטפל וירטואלי + מדריך בקורס</option>
            <option value="4">טסט</option>
          </select>
        </label>
      </div>
      <div><label>&nbsp;<br />
        <button id="btnRun">טען</button>
        <button id="btnClear">נקה</button>
      </label></div>
    </div>
    <div class="counts hint" id="countInfo"></div>
  </div>

  <div id="out" class="table"></div>
</div>

<script>
(function () {
  "use strict";

  window.addEventListener('error', function(e){
    var m = 'שגיאת סקריפט: ' + (e && e.message ? e.message : e);
    var sb = document.getElementById('statusBar');
    if (sb) sb.innerHTML = '<div class="err">'+m+'</div>';
  });

  /* Supabase */
  var SUPABASE_URL      = "https://qcwimczsiuxkarwfiyai.supabase.co";
  var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjd2ltY3pzaXV4a2Fyd2ZpeWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1OTEwMzgsImV4cCI6MjA2OTE2NzAzOH0.zpMcORTD1voqZFj5QaPUc-EXf1juqnlTTP00jV6_TvI";
  var TABLE             = "users_tzvira";
  var REVIEWS_TABLE     = "risk_reviews";
  var FLAGS_TABLE       = "talk_read_flags";
  var USERS_INFO_TABLE  = "users_information";

  var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function $(id){ return document.getElementById(id); }
  var el = {
    fPhone:$("fPhone"), fName:$("fName"), fFrom:$("fFrom"), fTo:$("fTo"), fKind:$("fKind"),
    btnRun:$("btnRun"), btnClear:$("btnClear"),
    out:$("out"), alertHost:$("alertHost"), statusBar:$("statusBar"), countInfo:$("countInfo")
  };


  var LS_STATUS_KEY = 'uvr_status_filter';

  // שחזור בחירת סטטוס מהפעם הקודמת, אם קיים
  try {
    if (window.localStorage) {
      var savedStatus = localStorage.getItem(LS_STATUS_KEY);
      if (savedStatus !== null) {
        el.fKind.value = savedStatus;
      }
    }
  } catch(e) {}
  var LIMIT = 100;

  function isYL(s){ return /^\d{4}\.\d{2}\.\d{2}$/.test(s||''); }
  function escapeHtml(s){ return String(s==null?'':s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }
  function stripAllHtml(raw){
    var s = String(raw==null?'':raw);
    s = s.replace(/<br\s*\/?>/gi, '\n');
    s = s.replace(/<\/?[^>]+>/g, '');
    return s;
  }
  function normalizeWs(raw){
    return String(raw==null?'':raw)
      .replace(/[\u200e\u200f\u202a-\u202e\u200b]/g,'')
      .replace(/\u00a0/g,' ')
      .replace(/\r/g,'')
      .replace(/[ \t]+\n/g, '\n')
      .replace(/\n{2,}/g, '\n');
  }
  function cleanTalk(raw){ return normalizeWs(stripAllHtml(raw)); }

  function b64Enc(str){ try{ return btoa(unescape(encodeURIComponent(String(str||'')))); }catch(e){ return ''; } }
  function b64Dec(str){ try{ return decodeURIComponent(escape(atob(String(str||'')))); }catch(e){ return ''; } }

  function sliceSummaryFromLastMarker(summary){
    var s = String(summary||'');
    if (!s) return s;
    var lines = s.split(/\n/);
    var lastIdx = -1;
    var rx = /^\s*(\d{2}\/\d{2}\/\d{4})\s*-\s*(\d{8}T\d{6}Z)\s*$/;
    for (var i=0;i<lines.length;i++){
      if (rx.test(lines[i])) lastIdx = i;
    }
    if (lastIdx === -1) return s;
    return lines.slice(lastIdx).join('\n');
  }

  function timeKeyToHuman(k){
    var s = String(k||'');
    var parts = s.split('-');
    if (parts.length === 2){
      var d = parts[0];
      var hhmmssms = parts[1].replace(/\./g, ':');
      return hhmmssms + '  ' + d;
    }
    return s;
  }

  function escapeRegExp(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  function ilStamp(ts){
    try{ return new Date(ts).toLocaleString('he-IL', { timeZone: 'Asia/Jerusalem', hour12: false }); }
    catch(e){ return ts; }
  }
  function nowISO(){ return new Date().toISOString(); }
  function setStatus(msg){ el.statusBar.innerHTML = msg ? '<div class="err">' + escapeHtml(msg) + '</div>' : ''; }
  function keyOf(time_key, phone){ return String(time_key||'') + '|' + String(phone||''); }

  function showInlineMsg(talkElem, msg){
    if (!talkElem) return;
    var box = talkElem.querySelector('.inline-msg');
    if (!box){
      box = document.createElement('div');
      box.className = 'inline-msg';
      var head = talkElem.querySelector('.head');
      if (head && head.nextSibling) talkElem.insertBefore(box, head.nextSibling);
      else talkElem.appendChild(box);
    }
    box.textContent = msg;
  }

  // -------------------------------
  // דיאלוג: תמיד יוצג "שם המטופל" / "המטפל" גם אם הגיעו פורמטים אחרים (Q/A, טיימסטמפ, וכו׳)
  // -------------------------------
  function toDialogLines(name, rawText){
    var patient = (name && String(name).trim()) ? String(name).trim() : 'מטופל/ת';

    // אופציונלית: טיימסטמפ של וואטסאפ בתחילת השורה, למשל: [0:19, 16.11.2025]
    var tsPrefix = '\\s*(?:\\[[^\\]]*\\]\\s*)?';

    // שם המטופל (משדה name) + נקודותיים
    var rxPatientName = new RegExp('^' + tsPrefix + escapeRegExp(patient) + ':\\s*');

    // המטפל:
    var rxTher = new RegExp('^' + tsPrefix + 'המטפל:\\s*');

    // תמיכה ב-Q: / A: (אם המערכת הקודמת מייצרת כך)
    var rxQ = new RegExp('^' + tsPrefix + 'Q:\\s*', 'i');
    var rxA = new RegExp('^' + tsPrefix + 'A:\\s*', 'i');

    // תמיכה במבנים גנריים "מטופל:" / "המטופל:" / "מטופל/ת:"
    var rxGenericPatient = new RegExp('^' + tsPrefix + '(?:המטופל|מטופל\\/ת|מטופל):\\s*');
    var rxGenericTher = new RegExp('^' + tsPrefix + '(?:המטפל):\\s*');

    var lines = String(rawText).split(/\n/);
    var out = [];

    for (var i=0;i<lines.length;i++){
      var s = String(lines[i]);

      // מטופל לפי השם
      if (rxPatientName.test(s)){
        out.push({ speaker:'patient', body:s.replace(rxPatientName,'') });
        continue;
      }

      // מטפל לפי "המטפל:" עם/בלי טיימסטמפ
      if (rxTher.test(s)){
        out.push({ speaker:'therapist', body:s.replace(rxTher,'') });
        out.push({ speaker:'spacer' });
        continue;
      }

      // Q: נחשב כמטופל
      if (rxQ.test(s)){
        out.push({ speaker:'patient', body:s.replace(rxQ,'') });
        continue;
      }

      // A: נחשב כמטפל
      if (rxA.test(s)){
        out.push({ speaker:'therapist', body:s.replace(rxA,'') });
        out.push({ speaker:'spacer' });
        continue;
      }

      // "מטופל:" / "המטופל:" וכו׳
      if (rxGenericPatient.test(s)){
        out.push({ speaker:'patient', body:s.replace(rxGenericPatient,'') });
        continue;
      }

      // "המטפל:" גנרי
      if (rxGenericTher.test(s)){
        out.push({ speaker:'therapist', body:s.replace(rxGenericTher,'') });
        out.push({ speaker:'spacer' });
        continue;
      }

      // תמיכה ישנה: "שאלה:" / "תשובה:"
      if (/^\s*שאלה:\s*/.test(s)){
        out.push({ speaker:'patient', body:s.replace(/^\s*שאלה:\s*/,'') });
        continue;
      }
      if (/^\s*תשובה:\s*/.test(s)){
        out.push({ speaker:'therapist', body:s.replace(/^\s*תשובה:\s*/,'') });
        out.push({ speaker:'spacer' });
        continue;
      }

      // שורה רגילה (טקסט חופשי)
      out.push({ speaker:'text', body:s });
    }

    return { patient: patient, lines: out };
  }

  function rx(s){ return new RegExp(s, "iu"); }
  var RISK = [
    {key:'suicide',    rx: rx("בא\\s*לי\\s*למות|רוצה\\s*למות|לא\\s*רוצה\\s*לחיות|אין\\s*לי\\s*בשביל\\s*מה\\s*לחיות|לסיים\\s*(?:את)?\\s*(?:ה(?:כול|כל|חיים))|להתאבד|התאבד(?:ו|ות)?|לפגוע\\s*בעצ(?:מי|מה|מו)|פגיעה\\s*עצמית|חתכ(?:תי|ים)|מנת\\s*יתר|הרס\\s*עצמי|ייאוש\\s*מוחלט|אין\\s*טעם|אני\\s*נואש|פאניקה\\s*קשה") },
    {key:'violence',   rx: rx("אהרוג|ארצח|לפגוע\\s*בו|אלימות\\s*קשה|מאיים\\s*עלי(?:י)?|עוקב\\s*אחר(?:י|ַי)|התעללות|אונס|הטרדה\\s*מינית") },
    {key:'psychosis',  rx: rx("פסיכוזה|שומע\\s*קולות|הלוצינציות") },
    {key:'substances', rx: rx("לקחתי\\s*יותר\\s*מדי\\s*תרופות|אלכוהול\\s*בכמויות") },
    {key:'hard_drugs', rx: rx("(סמים\\s*קשים|קוקאין|קראק|הרואין|פנטניל|מורפין|אוקסי(?:קודון)?|אופיאט(?:ים)?|מתאמפטמין|קריסטל(?:\\s*מת)?|(?:^|\\s)מת(?:\\s|$)|MDMA|אקסטז[יי]|LSD|אסיד|מסניף(?:ה)?|שואף(?:ת)?|הזרקתי|זריקה|מזרק|טריפ)") }
  ];

  function hashStr(str){
    var h=5381, i=0, cc;
    for (i=0;i<str.length;i++){ cc=str.charCodeAt(i); h=((h<<5)+h) ^ cc; }
    return (h>>>0).toString(16);
  }

  function collectRiskHits(dialogLines, talkDomId){
    var hits = [];
    for (var idx=0; idx<dialogLines.length; idx++){
      var ln = dialogLines[idx];
      if (ln.speaker !== 'patient') continue;
      var txt = String(ln.body || '');
      for (var k=0;k<RISK.length;k++){
        var rk = RISK[k];
        var m = txt.match(rk.rx);
        if (m){
          var matchText = m[0];
          var hash = hashStr(matchText.replace(/\s+/g,' ').toLowerCase() + '|' + rk.key);
          var targetId = 'line-' + talkDomId + '-' + idx + '-' + hash.slice(0,6);
          ln._anchorId = targetId;
          hits.push({hash:hash, pattern_key:rk.key, targetId:targetId, lineIndex:idx, matchText:matchText});
        }
      }
    }
    return hits;
  }

  function loadReviewedMap(time_key, phone, hashArr){
    if (!hashArr.length) return Promise.resolve(new Map());
    return supa.from(REVIEWS_TABLE)
      .select('snippet_hash, reviewed_at, reviewed_by, status')
      .eq('time_key', time_key)
      .eq('phone', phone)
      .eq('status','reviewed')
      .in('snippet_hash', hashArr)
      .then(function(res){
        if (res.error) return new Map();
        var mp = new Map();
        (res.data||[]).forEach(function(r){ mp.set(r.snippet_hash, {reviewed_at:r.reviewed_at, reviewed_by:r.reviewed_by||''}); });
        return mp;
      });
  }

  function snippetAround(full, match){
    var s = String(full), idx = s.indexOf(match);
    if (idx === -1) return s.slice(0, 60);
    var start = Math.max(0, idx - 18), end = Math.min(s.length, idx + match.length + 18);
    return (start>0?'…':'') + s.slice(start, end).trim() + (end<s.length?'…':'');
  }

  function renderDialogHtml(patientName, dialogLines, hits, reviewedMap){
    var html = [];
    for (var i=0;i<dialogLines.length;i++){
      var ln = dialogLines[i];
      if (ln.speaker === 'patient'){
        var body = escapeHtml(ln.body || '');
        var h=null;
        for (var j=0;j<hits.length;j++){ if (hits[j].lineIndex===i){ h=hits[j]; break; } }
        if (h){
          var rxm = new RegExp(escapeRegExp(h.matchText), 'u');
          var note = '';
          var cls = 'risk';
          var btn = '';
          var snippet = snippetAround(ln.body||'', h.matchText);

          if (reviewedMap.has(h.hash)){
            var r = reviewedMap.get(h.hash);
            var stamp = ilStamp(r.reviewed_at);
            note = ' <span class="note-yellow">(המטפל בדק בתאריך ' + escapeHtml(stamp) + (r.reviewed_by?(', ' + escapeHtml(r.reviewed_by)):'') + ')</span>';
            cls += ' reviewed';
            btn = ' <button class="btn-unreview-inline" data-hash="'+escapeHtml(h.hash)+'" data-pattern="'+escapeHtml(h.pattern_key)+'" data-snippet="'+escapeHtml(snippet)+'" title="בטל סימון">בטל סימון</button>';
          } else {
            btn = ' <button class="btn-review-inline" data-hash="'+escapeHtml(h.hash)+'" data-pattern="'+escapeHtml(h.pattern_key)+'" data-snippet="'+escapeHtml(snippet)+'" title="סמן כטופל">סמן כטופל</button>';
          }
          body = body.replace(rxm, '<mark class="' + cls + '" data-hash="'+escapeHtml(h.hash)+'" data-pattern="'+escapeHtml(h.pattern_key)+'">$&</mark>' + note + btn);
        }
        html.push('<div class="line speaker"><span class="speaker speaker-patient">' + escapeHtml(patientName) + ':</span> <span id="' + escapeHtml(ln._anchorId||'') + '">' + body + '</span></div>');
      } else if (ln.speaker === 'therapist'){
        html.push('<div class="line speaker"><span class="speaker speaker-therapist">המטפל:</span> ' + escapeHtml(ln.body || '') + '</div>');
      } else if (ln.speaker === 'spacer'){
        html.push('<div class="line-spacer"></div>');
      } else {
        html.push('<div class="line">' + escapeHtml(ln.body || '') + '</div>');
      }
    }
    return html.join('\n');
  }

  function queryPage(){
    setStatus('');
    var fromIdx = 0, toIdx = LIMIT - 1;
    var talkKind = (el.fKind.value || '').trim(); // "1" / "2"

    var q = supa.from(TABLE)
      .select('time, phone, name, last_talk_tzvira, summarized_linked_talk', { count:'exact' })
      .order('time', { ascending: true });

    if (el.fPhone.value.trim()) q = q.ilike('phone', '%' + el.fPhone.value.trim() + '%');
    if (el.fName.value.trim())  q = q.ilike('name',  '%' + el.fName.value.trim() + '%');
    var f = el.fFrom.value.trim(), t = el.fTo.value.trim();
    if (isYL(f) && isYL(t))      q = q.gte('time', f + '-00.00.00').lte('time', t + '-23.59.59');
    else if (isYL(f))            q = q.gte('time', f + '-00.00.00');
    else if (isYL(t))            q = q.lte('time', t + '-23.59.59');

    q = q.range(fromIdx, toIdx).then(function(res){
      if (res.error){
        setStatus('שגיאת נתונים: ' + res.error.message);
        el.out.innerHTML = '';
        el.alertHost.innerHTML = '';
        el.countInfo.textContent = '';
        return;
      }

      var lastCount = res.count || 0;
      var rows = res.data || [];
      var times = [], phones = [], ST = new Set(), SP = new Set();
      for (var i=0;i<rows.length;i++){
        var r = rows[i];
        if (r.time && !ST.has(r.time)){ ST.add(r.time); times.push(r.time); }
        if (r.phone && String(r.phone).trim()!==''){
          var p = String(r.phone).trim();
          if (!SP.has(p)){ SP.add(p); phones.push(p); }
        }
      }

      function fetchFlags(timesArr, phonesArr){
        if (!rows.length || !timesArr.length || !phonesArr.length){
          return Promise.resolve(new Map());
        }
        return supa.from(FLAGS_TABLE)
          .select('time_key, phone, is_hidden')
          .in('time_key', timesArr)
          .in('phone', phonesArr)
          .then(function(fres){
            var flagsMap = new Map();
            if (!fres.error){
              (fres.data||[]).forEach(function(fr){
                var k = keyOf(fr.time_key, fr.phone);
                flagsMap.set(k, { is_hidden: !!fr.is_hidden });
              });
            }
            return flagsMap;
          });
      }

      function fetchStatuses(phonesArr){
        if (!phonesArr.length){
          return Promise.resolve(new Map());
        }
        return supa.from(USERS_INFO_TABLE)
          .select('phone, status')
          .in('phone', phonesArr)
          .then(function(resInfo){
            var infoMap = new Map();
            if (!resInfo.error){
              (resInfo.data || []).forEach(function(row){
                var p = String(row.phone || '').trim();
                if (!p) return;
                infoMap.set(p, { status: row.status });
              });
            }
            return infoMap;
          });
      }

      Promise.all([fetchFlags(times, phones), fetchStatuses(phones)]).then(function(allMaps){
        var flagsMap = allMaps[0] || new Map();
        var infoMap  = allMaps[1] || new Map();

        render(rows, flagsMap, infoMap, talkKind).then(function(info){
          var patients = info.patientsCount || 0;
          var openTalks = info.shownCount || 0;
          var hiddenTalks = info.hiddenCount || 0;
          el.countInfo.textContent = 'מציג ' + patients + ' מטופלים · ' + openTalks + ' שיחות פתוחות · ' + hiddenTalks + ' שיחות מוסתרות';
        }).catch(function(e){
          setStatus('שגיאת רינדור: ' + (e && e.message ? e.message : e));
        });
      });
    });
  }

  function render(rows, flagsMap, infoMap, talkKind){
    return new Promise(function(resolve){
      var parts = [], alerts = [];
      var hiddenCount = 0, shownCount = 0;
      var patientsShown = new Set();

      function isRowAllowed(row){
        var kind = talkKind;
        // אם לא נבחר סטטוס – אין סינון לפי סטטוס
        if (!kind){ return true; }

        var phoneKey = row.phone ? String(row.phone).trim() : '';
        if (!phoneKey){ return false; }

        var info = infoMap.get(phoneKey);
        // אם אין סטטוס למטופל – לא ייכנס לרשימה כאשר יש פילטר
        if (!info || info.status == null){ return false; }

        var sVal = parseInt(info.status, 10);
        var kVal = parseInt(kind, 10);
        if (!isFinite(kVal)){ return true; }

        // מסננים רק מטופלים שהסטטוס שלהם שווה לפילטר שנבחר
        return sVal === kVal;
      }

      function nextRow(i){
        if (i >= rows.length){
          var totalHits = alerts.reduce(function(sum, a){ return sum + (a.items ? a.items.length : 0); }, 0);

          el.out.innerHTML = parts.join('') || '<div class="card hint">אין תוצאות.</div>';

          if (alerts.length){
            var top = ['<div class="alertbar"><h3>⚠️ נמצאו ' + totalHits + ' ביטויי סיכון ב-' + alerts.length + ' שיחות</h3>'];
            for (var a=0;a<alerts.length;a++){
              var AA = alerts[a];
              top.push('<div class="alertitem" data-time="' + escapeHtml(AA.time_key) + '" data-phone="' + escapeHtml(AA.phone) + '">');
              top.push('<div><strong>' + escapeHtml(AA.name) + '</strong> · ' + escapeHtml(AA.phone) + '</div>');
              top.push('<div class="when">' + escapeHtml(AA.time) + '</div><div>');
              for (var z=0; z<AA.items.length; z++){
                var it = AA.items[z];
                top.push('<span class="pill mono" title="' + escapeHtml(it.text) +'">'+ escapeHtml(it.text) +'</span> ');
                top.push('<button class="btn-open-risk" data-act="goto" data-target="' + escapeHtml(it.targetId) + '">פתח את הסיכון</button> ');
              }
              top.push('</div></div>');
            }
            top.push('</div>');
            el.alertHost.innerHTML = top.join('');
            el.alertHost.querySelectorAll('button[data-act="goto"]').forEach(function(btn){
              btn.addEventListener('click', function(){
                var id = btn.getAttribute('data-target');
                var node = id ? document.getElementById(id) : null;
                if (!node) return;
                node.scrollIntoView({behavior:'smooth', block:'center'});
                node.classList.add('target-blink');
                setTimeout(function(){ node.classList.remove('target-blink'); }, 1300);
              });
            });
          } else {
            el.alertHost.innerHTML = '';
          }

          resolve({ hiddenCount:hiddenCount, shownCount:shownCount, totalHits:totalHits, patientsCount: patientsShown.size });
          return;
        }

        var r = rows[i];

        // סינון לפי סטטוס ב-users_information וסוג שיחה
        if (!isRowAllowed(r)){
          nextRow(i+1);
          return;
        }

        var talkClean = cleanTalk(r.last_talk_tzvira || '');
        var parsed = toDialogLines(r.name, talkClean);
        var talkDomId = (r.time || '').replace(/[^0-9]/g,'') || Math.random().toString(36).slice(2);

        var hits = collectRiskHits(parsed.lines, talkDomId);
        var uniq = []; var seen = {};
        for (var h=0; h<hits.length; h++){ var hh = hits[h]; if (!seen[hh.hash]){ seen[hh.hash]=1; uniq.push(hh.hash); } }

        loadReviewedMap(r.time, r.phone, uniq).then(function(reviewedMap){
          var notRev = [];
          for (var h2=0; h2<hits.length; h2++){
            if (!reviewedMap.has(hits[h2].hash)) notRev.push(hits[h2]);
          }

          var k = keyOf(r.time, r.phone);
          var flag = flagsMap.get(k);
          var isHidden = !!(flag && flag.is_hidden);

          if (!isHidden && notRev.length){
            var items = [];
            for (var nn=0; nn<notRev.length; nn++){
              var hh2 = notRev[nn];
              var bodyTxt = parsed.lines[hh2.lineIndex].body;
              items.push({ text: snippetAround(bodyTxt, hh2.matchText), hash: hh2.hash, pattern_key: hh2.pattern_key, targetId: parsed.lines[hh2.lineIndex]._anchorId });
            }
            alerts.push({
              name: r.name || 'מטופל/ת',
              phone: r.phone || '',
              time: timeKeyToHuman(r.time),
              time_key: r.time,
              items: items
            });
          }

          var nameHtml  = '<span class="patient-name">' + escapeHtml(r.name || 'מטופל/ת') + '</span>';
          var phoneHtml = '<span class="patient-phone">' + escapeHtml(r.phone || '') + '</span>';
          var btnLabel  = isHidden ? 'הצג שיחה' : 'הסתר שיחה';

          var toggleClasses = 'btn-toggle btn-state-active';
          // כפתור "הצג מקוצרת" פתוח רק כאשר השיחה מוצגת (לא מוסתרת) ואין ביטויי סיכון פתוחים
          var summClasses   = 'btn-summarized_linked_talk btn-state-active';
          var rawHasContent = !!(r.summarized_linked_talk && String(r.summarized_linked_talk).trim());

          var headParts = [];
          headParts.push('<div class="head">');
          headParts.push('<div class="head-name">', nameHtml, '</div>');
          headParts.push('<div class="head-phone">', phoneHtml, '</div>');

          var canToggle = (isHidden || (!isHidden && notRev.length === 0));
          var canSumm   = (!isHidden && notRev.length === 0);
          var canRaw    = (!isHidden && rawHasContent);

          // כפתור "הצג שיחה" – או פלייסהולדר כאשר אינו זמין
          if (canToggle) {
            headParts.push(
              '<button class="' + toggleClasses + '" data-time="', escapeHtml(r.time),
              '" data-phone="', escapeHtml(r.phone||''),
              '" data-name="', escapeHtml(r.name||''),
              '" data-hidden="', (isHidden?'1':'0'),
              '" data-notrev="', (notRev.length), '">',
              btnLabel,
              '</button>'
            );
          } else {
            headParts.push('<button class="btn-placeholder">' + btnLabel + '</button>');
          }

          // כפתור "הצג מקוצרת" – או פלייסהולדר כאשר אינו זמין
          if (canSumm) {
            headParts.push(
              '<button class="' + summClasses + '" data-notrev="', (notRev.length), '">הצג מקוצרת</button>'
            );
          } else {
            headParts.push('<button class="btn-placeholder">הצג מקוצרת</button>');
          }

          // כפתור "הצג שיחות קודמות" – או פלייסהולדר כאשר אינו זמין
          if (canRaw) {
            headParts.push(
              '<button class="btn-raw-summary btn-state-active" title="הצג את summarized_linked_talk כפי שהוא">הצג שיחות קודמות</button>'
            );
          } else {
            headParts.push('<button class="btn-placeholder">הצג שיחות קודמות</button>');
          }

          headParts.push(
            '<span class="meta mono">', escapeHtml(timeKeyToHuman(r.time)), '</span>',
            '<button class="btn-home" title="חזרה למסך הראשון">חזרה למסך הראשון</button>',
            '</div>'
          );

          var headHtml = headParts.join('');

          parts.push('<div class="talk" data-time="' + escapeHtml(r.time) + '" data-phone="' + escapeHtml(r.phone||'') + '" data-name="'+escapeHtml(r.name||'')+'">');
          parts.push(headHtml);

          if (isHidden){
            hiddenCount++;
          } else {
            shownCount++;
            if (r.phone) {
              patientsShown.add(String(r.phone).trim());
            }
            var dialogHtml = renderDialogHtml(parsed.patient, parsed.lines, hits, reviewedMap);
            parts.push('<div class="body">' + dialogHtml + '</div>');

            var sumRaw = (r.summarized_linked_talk || '').trim();
            var sumCut = sliceSummaryFromLastMarker(sumRaw);
            var sumHtml = sumCut ? escapeHtml(sumCut) : '<span class="empty">אין סיכום שיחה.</span>';
            var sumRawB64 = b64Enc(sumRaw);

            parts.push('<div class="summarized_linked_talk" data-raw-b64="'+escapeHtml(sumRawB64)+'">'+ sumHtml +'</div>');
          }

          parts.push('</div>');
          nextRow(i+1);
        });
      }
      nextRow(0);
    });
  }

  // האזנות על רשימת התוצאות
  document.getElementById('out').addEventListener('click', function(ev){
    var btnHome = ev.target.closest('.btn-home');
    if (btnHome){
      el.fPhone.value=''; el.fName.value=''; el.fFrom.value=''; el.fTo.value='';
      queryPage();
      window.scrollTo({top:0, behavior:'smooth'});
      return;
    }

    var btnToggle = ev.target.closest('.btn-toggle');
    if (btnToggle){
      var talkElem = btnToggle.closest('.talk');
      var time_key = btnToggle.getAttribute('data-time');
      var phone    = btnToggle.getAttribute('data-phone');
      var name     = btnToggle.getAttribute('data-name') || null;
      var isHidden = btnToggle.getAttribute('data-hidden') === '1';
      var notRevCount = parseInt(btnToggle.getAttribute('data-notrev')||'0',10);

      if (!isHidden && notRevCount > 0){
        showInlineMsg(talkElem, 'לא ניתן להסתיר שיחה כל עוד קיימים ביטויי סיכון שלא טופלו.');
        return;
      }

      var payload = { time_key: time_key, phone: phone, is_hidden: !isHidden, toggled_by: 'viewer_default', patient_name: name };

      supa.from(FLAGS_TABLE)
          .upsert(payload, { onConflict: 'time_key,phone' })
          .then(function(res2){
            if (res2.error){
              showInlineMsg(talkElem, 'שגיאה בעדכון מצב השיחה: ' + (res2.error.message || 'unknown'));
              return;
            }
            queryPage();
          });
      return;
    }

    var btnSumm = ev.target.closest('.btn-summarized_linked_talk');
    if (btnSumm){
      var talk = btnSumm.closest('.talk');
      var notRev = parseInt(btnSumm.getAttribute('data-notrev')||'0',10);
      var body = talk.querySelector('.body');
      var sum  = talk.querySelector('.summarized_linked_talk');

      if (body && sum && body.style.display !== 'none' && notRev > 0){
        showInlineMsg(talk, 'לא ניתן לעבור למקוצרת כל עוד קיימים ביטויי סיכון שלא טופלו.');
        return;
      }

      if (body && sum){
        var showingFull = (body.style.display !== 'none');
        if (showingFull){
          body.style.display = 'none';
          sum.style.display  = 'block';
          btnSumm.textContent = 'הצג מלאה';
          btnSumm.classList.add('btn-selected');
        } else {
          sum.style.display  = 'none';
          body.style.display = 'block';
          btnSumm.textContent = 'הצג מקוצרת';
          btnSumm.classList.remove('btn-selected');
        }
      }
      return;
    }

    var btnRaw = ev.target.closest('.btn-raw-summary');
    if (btnRaw){
      var talk = btnRaw.closest('.talk');
      var body = talk.querySelector('.body');
      var sum  = talk.querySelector('.summarized_linked_talk');
      if (!sum) return;

      var showingRaw = btnRaw.getAttribute('data-showing') === '1';
      if (!showingRaw){
        var rawB64 = sum.getAttribute('data-raw-b64') || '';
        var rawTxt = b64Dec(rawB64);
        if (!rawTxt){ showInlineMsg(talk, 'אין תוכן סיכום שיחות'); return; }

        if (body) body.style.display = 'none';
        sum.style.display = 'block';
        sum.textContent   = rawTxt;
        btnRaw.textContent = 'הצג שיחה';
        btnRaw.setAttribute('data-showing','1');
        btnRaw.classList.add('btn-selected');
      } else {
        if (sum)  sum.style.display  = 'none';
        if (body) body.style.display = 'block';
        btnRaw.textContent = 'הצג שיחות קודמות';
        btnRaw.setAttribute('data-showing','0');
        btnRaw.classList.remove('btn-selected');
      }
      return;
    }

    var btnReview = ev.target.closest('.btn-review-inline');
    if (btnReview){
      var talkElem2 = btnReview.closest('.talk');
      var time_key2 = talkElem2 ? talkElem2.getAttribute('data-time') : null;
      var phone2    = talkElem2 ? talkElem2.getAttribute('data-phone') : null;
      var name2     = talkElem2 ? talkElem2.getAttribute('data-name')  : null;

      var hash     = btnReview.getAttribute('data-hash');
      var pattern  = btnReview.getAttribute('data-pattern');
      var text     = btnReview.getAttribute('data-snippet') || '';

      var payload2 = {
        time_key: time_key2, phone: phone2, patient_name: name2,
        snippet_hash: hash, snippet_text: text, pattern_key: pattern,
        status:'reviewed', reviewed_at: nowISO(), reviewed_by:null
      };

      supa.from(REVIEWS_TABLE)
          .upsert(payload2, { onConflict: 'time_key,phone,snippet_hash' })
          .then(function(res3){
        if (res3.error){
          showInlineMsg(talkElem2, 'שגיאה בסימון: ' + (res3.error.message || 'unknown'));
          return;
        }
        queryPage();
      });
      return;
    }

    var btnUnreview = ev.target.closest('.btn-unreview-inline');
    if (btnUnreview){
      var talkElem3 = btnUnreview.closest('.talk');
      var time_key3 = talkElem3 ? talkElem3.getAttribute('data-time') : null;
      var phone3    = talkElem3 ? talkElem3.getAttribute('data-phone') : null;
      var hash3     = btnUnreview.getAttribute('data-hash');

      supa.from(REVIEWS_TABLE)
          .update({ status:'pending' })
          .eq('time_key', time_key3)
          .eq('phone', phone3)
          .eq('snippet_hash', hash3)
          .then(function(res4){
            if (res4.error){
              showInlineMsg(talkElem3, 'שגיאה בביטול סימון: ' + (res4.error.message || 'unknown'));
              return;
            }
            queryPage();
          });
    }
  });


  // שינוי סטטוס – שומר ב-localStorage ומרענן את הרשימה
  el.fKind.addEventListener('change', function(){
    try {
      if (window.localStorage) {
        localStorage.setItem(LS_STATUS_KEY, el.fKind.value || '');
      }
    } catch(e) {}
    queryPage();
  });
  el.btnRun.onclick   = function(){ queryPage(); };
  el.btnClear.onclick = function(){
    el.fPhone.value='';
    el.fName.value='';
    el.fFrom.value='';
    el.fTo.value='';
    queryPage();
  };

  queryPage();
})();
</script>
</body>
</html>
