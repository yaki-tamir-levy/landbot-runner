<!doctype html>
<html lang="he" dir="rtl">
<head>
  <script>
  (function () {
    // אותה הסיסמה כמו בקובץ launcher.html
    const APP_PASSWORD   = "yon1234";
    const EXPECTED_TOKEN = "ok-" + btoa(APP_PASSWORD);

    try {
      const token = sessionStorage.getItem("riskAppAuth");

      // אם אין טוקן תקין – מחזירים למסך הכניסה
      if (token !== EXPECTED_TOKEN) {
        window.location.href = "launcher.html";
        return;
      }

      // אם הגענו לכאן – הטוקן תקין עבור הכניסה הנוכחית.
      // מנקים אותו מיד כדי שכל טעינה מחדש תדרוש סיסמה מחדש.
      sessionStorage.removeItem("riskAppAuth");
    } catch (e) {
      window.location.href = "launcher.html";
    }
  })();
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>כל הסוגים</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.js"></script>
  <style>
    :root { --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --divider:#e5e7eb; --danger:#7f1d1d; --ok:#065f46; --hi:#fde68a; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1000px;margin:0 auto;padding:20px}
    h2{margin:0 0 12px 0; text-align:center}
    .card{background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:var(--muted)}
    input,button,select{background:#fff;color:var(--ink);border:1px solid var(--divider);border-radius:10px;padding:8px 10px}
    input::placeholder{color:#9ca3af}
    button{cursor:pointer}
    .controls{margin-bottom:10px}
    .table{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .talk{border:1px solid var(--divider);border-radius:12px;overflow:hidden;background:#fff}
    .head{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:8px;
  background:#fafafa;
  padding:10px 12px;
  border-bottom:1px solid #e5e7eb
}
.patient-name{font-weight:900;font-size:1.35rem;}
    .patient-phone{font-weight:400;font-size:0.9rem;color:var(--muted);}
    .btn-toggle,.btn-summarized_linked_talk,.btn-raw-summary,.btn-home{
      font-weight:700; border:2px solid #d1d5db; border-radius:10px; padding:8px 10px; background:#fff; min-width:140px; text-align:center
    }
    .btn-home{font-weight:400; min-width:150px; border-width:1px}
    .btn-selected{ background:#f3e8ff !important; border-color:#e9d5ff !important; }
    .btn-placeholder{ display:none; }
    .btn-state-active{ background:#dcfce7; border-color:#bbf7d0; }
    .btn-summarized_linked_talk[disabled]{opacity:.55; cursor:not-allowed}
    .btn-toggle:hover,.btn-summarized_linked_talk:hover,.btn-raw-summary:hover{box-shadow:0 0 0 2px #e5e7eb inset}
    .meta{color:var(--muted);font-weight:600}
    .body{padding:12px;white-space:pre-wrap;line-height:1.55}
    .summarized_linked_talk{padding:12px; white-space:pre-wrap; line-height:1.6; background:#fffaf0; border-top:1px dashed #f1d29b; display:none}
    .summarized_linked_talk .empty{color:#9ca3af}
    .hint{color:#6b7280;font-size:12px}
    .counts{margin-top:6px}
    mark.risk{ background:#ffe4e6; color:#000; padding:0 3px; border-radius:4px; font-weight:900; font-size:1.08em; }
    mark.risk.reviewed{ background:#d1fae5; color:#065f46; }
    .alertbar{border:1px solid #fecaca;background:#fee2e2;border-radius:12px;padding:10px 12px;margin:0 0 10px}
    .alertbar h3{margin:0 0 6px 0;color:#7f1d1d;font-size:14px}
    .alertitem{margin:6px 0;padding:8px 10px;border-radius:8px;background:#fff;border:1px dashed #fecaca}
    .alertitem .when{color:#7f1d1d;font-weight:700}
    .pill{ display:inline-block; padding:6px 12px; border-radius:999px; background:#ffe4e6; color:#000; font-size:16px; margin:2px 6px 2px 0; font-weight:900; border:1px solid #fecaca }
    .btn-open-risk{ font-weight:900; background:#ffd1d6; border:2px solid #fca5a5; padding:6px 12px; border-radius:10px; }
    .btn-open-risk:hover{ filter:brightness(0.98) }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .speaker{white-space:pre-wrap}
    .speaker-patient{font-weight:700}
    .speaker-therapist{font-weight:800;font-style:italic;font-size:1.05em}
    .line-spacer{height:1em}
    .target-blink{animation: blink 1.3s ease-in-out 1}
    @keyframes blink{ 0%{background:var(--hi)} 100%{background:transparent} }
    #statusBar{margin:10px 0}
    #statusBar .err{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:10px;border-radius:10px}
    #statusBar .ok{background:#dcfce7;border:1px solid #bbf7d0;color:#065f46;padding:10px;border-radius:10px}
    .inline-msg{margin:8px 12px;background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:8px 10px;border-radius:10px}
    .note-yellow{background:var(--hi); padding:0 4px; border-radius:4px}
    .btn-review-inline,.btn-unreview-inline{margin-inline-start:8px}

  .meta.why{ display:inline-block; margin:0 8px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
</style>
</head>
<body>

<!-- VERSION BADGE -->
<div style="position:fixed;top:6px;left:6px;z-index:9999;
background:#111827;color:#fff;font-size:11px;
padding:3px 8px;border-radius:8px;opacity:0.7;">
v02
</div>


<div class="wrap">
  <h2 id="pageTitle">כל הסוגים</h2>

  <div id="statusBar"></div>
  <div id="alertHost"></div>

  <div class="card controls">
    <div class="row">
      <div><label>Phone<br /><input id="fPhone" placeholder="+9725..." /></label></div>
      <div><label>Name<br /><input id="fName" placeholder="שם" /></label></div>
      <div><label>From (YYYY.MM.DD)<br /><input id="fFrom" placeholder="2025.11.01" /></label></div>
      <div><label>To (YYYY.MM.DD)<br /><input id="fTo" placeholder="2025.11.30" /></label></div>
      <div>
        <label>בחר סטטוס מטופל<br />
          <select id="fKind">
            <option value="" selected>הכל</option>
            <option value="1">מטפל וירטואלי</option>
            <option value="2">מדריך קורס</option>
            <option value="3">מטפל וירטואלי + מדריך בקורס</option>
            <option value="4">טסט</option>
          </select>
        </label>
      </div>
      <div><label>&nbsp;<br />
        <button id="btnRun">טען</button>
        <button id="btnClear">נקה</button>
      </label></div>
    </div>
    <div class="counts hint" id="countInfo"></div>
  </div>

  <div id="out" class="table"></div>
</div>

<script>
(function () {
  "use strict";

  function $(id){ return document.getElementById(id); }
  var el = {
    fPhone:$("fPhone"), fName:$("fName"), fFrom:$("fFrom"), fTo:$("fTo"), fKind:$("fKind"),
    btnRun:$("btnRun"), btnClear:$("btnClear"),
    out:$("out"), alertHost:$("alertHost"), statusBar:$("statusBar"), countInfo:$("countInfo")
  };

  // default date range: To = today (leave empty = ALL)
  try{
    if (!el.fTo.value || String(el.fTo.value).trim() === '2025.12.31'){
      el.fTo.value = todayYMD();
    }
  } catch(e){}

  function escapeHtml(s){ return String(s==null?'':s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }
  function setStatusErr(msg){ el.statusBar.innerHTML = msg ? '<div class="err">' + escapeHtml(msg) + '</div>' : ''; }
  function setStatusOk(msg){ el.statusBar.innerHTML = msg ? '<div class="ok">' + escapeHtml(msg) + '</div>' : ''; }

  window.addEventListener('error', function(e){
    var m = 'שגיאת סקריפט: ' + (e && e.message ? e.message : e);
    setStatusErr(m);
  });

  /* Supabase */
  var SUPABASE_URL      = "https://qcwimczsiuxkarwfiyai.supabase.co";
  var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjd2ltY3pzaXV4a2Fyd2ZpeWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1OTEwMzgsImV4cCI6MjA2OTE2NzAzOH0.zpMcORTD1voqZFj5QaPUc-EXf1juqnlTTP00jV6_TvI";
  var TABLE             = "users_tzvira";
  var REVIEWS_TABLE     = "risk_reviews";
  var FLAGS_TABLE       = "talk_read_flags";
  var USERS_INFO_TABLE  = "users_information";

  if (!window.supabase || !window.supabase.createClient){
    setStatusErr('ספריית Supabase לא נטענה (בדוק חיבור אינטרנט / חסימת CDN).');
    return;
  }
  var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ------------------------------------------------------------
  // users_information.status backfill — at most one DB call per phone
  // Goal: never show "לא ידוע" if the status exists in users_information.
  // ------------------------------------------------------------
  var UI_STATUS_FETCH = new Map(); // normPhone(phone) -> Promise<any|null>

  function uiPhoneVariants(rawPhone){
    var s = String(rawPhone == null ? '' : rawPhone).trim();
    var digits = s.replace(/\D+/g,'');
    var set = new Set();
    if (digits) set.add(digits);

    if (digits.length === 9) set.add('0' + digits);
    if (digits.length === 10 && digits.charAt(0) === '0'){
      set.add(digits.slice(1));
      set.add('972' + digits.slice(1));
    }

    if (digits.startsWith('972') && digits.length >= 11){
      var rest = digits.slice(3);
      if (rest.length === 9) set.add('0' + rest);
      if (rest.length === 10) set.add(rest);
      set.add(rest);
    }

    if (/^\d+$/.test(s)) set.add(s);
    return Array.from(set).filter(function(x){ return x && String(x).trim() !== ''; });
  }

  function hasInfoStatus(phoneRaw){
    try{
      var info = CACHE && CACHE.infoMap ? CACHE.infoMap.get(normPhone(phoneRaw)) : null;
      return !!(info && info.status != null && String(info.status).trim() !== '');
    } catch(e){
      return false;
    }
  }

  function fetchUsersInformationStatusOnce(phoneRaw){
    var key = normPhone(phoneRaw);
    if (UI_STATUS_FETCH.has(key)) return UI_STATUS_FETCH.get(key);

    // if already present in cache, don't hit DB
    if (hasInfoStatus(phoneRaw)){
      var p0 = Promise.resolve(CACHE.infoMap.get(key).status);
      UI_STATUS_FETCH.set(key, p0);
      return p0;
    }

    var variants = uiPhoneVariants(phoneRaw);
    var orParts = variants.map(function(v){ return 'phone.eq.' + v; }).join(',');
    var p = supa.from(USERS_INFO_TABLE)
      .select('status, phone')
      .or(orParts)
      .limit(1)
      .then(function(res){
        var row = (res && res.data && res.data.length) ? res.data[0] : null;
        if (row && row.status != null && String(row.status).trim() !== ''){
          // backfill into CACHE.infoMap so filters/labels use it everywhere
          putInfoStatus(phoneRaw, row.status);
          return row.status;
        }
        return null;
      })
      .catch(function(){
        return null;
      });

    UI_STATUS_FETCH.set(key, p);
    return p;
  }

  function ensureUsersInformationForRows(rows){
    var uniq = new Map(); // key->raw
    (rows || []).forEach(function(r){
      var raw = (r && r.phone != null) ? r.phone : '';
      var k = normPhone(raw);
      if (!uniq.has(k)) uniq.set(k, raw);
    });

    var ps = [];
    uniq.forEach(function(raw, k){
      if (!hasInfoStatus(raw)){
        ps.push(fetchUsersInformationStatusOnce(raw));
      }
    });
    return Promise.all(ps);
  }

  function putInfoStatus(phoneRaw, statusVal){
    var status = statusVal;
    if (status == null || String(status).trim() === '') return;

    var s = String(phoneRaw == null ? '' : phoneRaw).trim();
    var digits = s.replace(/\D+/g,'');
    var keys = new Set();

    // normalized main key
    var norm = normPhone(phoneRaw);
    if (norm) keys.add(norm);

    if (digits) keys.add(digits);
    if (digits.length === 9) keys.add('0' + digits);
    if (digits.length === 10 && digits.charAt(0) === '0'){
      keys.add(digits.slice(1));
      keys.add('972' + digits.slice(1));
    }
    if (digits.startsWith('972') && digits.length >= 11){
      var rest = digits.slice(3);
      keys.add(rest);
      if (rest.length === 9) keys.add('0' + rest);
      if (rest.length === 10) keys.add(rest);
    }

    keys.forEach(function(k){
      if (!k) return;
      try{ CACHE.infoMap.set(k, { status: status }); } catch(e){}
    });
  }

  // ------------------------------------------------------------
  // CACHE MODE (Stage 1):
  // טעינה ראשונית מביאה *את כל הנתונים* (ללא סלקציה) כדי ששום RISK לא יחמוק.
  // לאחר מכן כל סלקציה היא מקומית (ללא רשת), ושיחות עם RISK עוקפות סלקציות.
  // ------------------------------------------------------------
  var CACHE = {
    loaded: false,
    allRows: [],
    flagsMap: new Map(),   // key(time_key,phone) -> {is_hidden}
    infoMap:  new Map(),   // phone -> {status}
    riskMap:  new Map(),   // key(time_key,phone) -> [riskRows]
    riskKeySet: new Set()  // key(time_key,phone)
  };

  function fetchAllPaged(tableName, selectCols, orderCol){
    var pageSize = 1000;
    var out = [];
    var offset = 0;

    function step(){
      var q = supa.from(tableName).select(selectCols);
      if (orderCol) q = q.order(orderCol, { ascending: true });
      return q.range(offset, offset + pageSize - 1).then(function(res){
        if (res.error){
          throw new Error('Fetch failed for ' + tableName + ': ' + (res.error.message || 'unknown'));
        }
        var data = res.data || [];
        out = out.concat(data);
        if (data.length < pageSize) return out;
        offset += pageSize;
        return step();
      });
    }
    return step();
  }

  function buildRiskCache(allRisk){
    CACHE.riskMap = new Map();
    CACHE.riskKeySet = new Set();
    (allRisk || []).forEach(function(rr){
      var tk = rr.time_key;
      var ph = rr.phone;
      if (!tk || !ph) return;
      var k = keyOf(tk, ph);
      CACHE.riskKeySet.add(k);
      var arr = CACHE.riskMap.get(k);
      if (!arr){ arr = []; CACHE.riskMap.set(k, arr); }
      arr.push(rr);
    });
  }

  function markRowsWithRisk(){
    (CACHE.allRows || []).forEach(function(r){
      r._forceRisk = CACHE.riskKeySet.has(keyOf(r.time_key, r.phone));
    });
  }

  function loadAllDataFromServer(){
    setStatusErr('');
    setStatusOk('טעינה ראשונית: מביא את כל השיחות ללא סלקציה…');

    CACHE.loaded = false;
    CACHE.allRows = [];
    CACHE.flagsMap = new Map();
    CACHE.infoMap = new Map();
    CACHE.riskMap = new Map();
    CACHE.riskKeySet = new Set();

    return fetchAllPaged(TABLE, 'time_key, phone, name, last_talk_tzvira, summarized_linked_talk', 'time_key')
      .then(function(allRows){
        CACHE.allRows = allRows || [];
        setStatusOk('נטענו ' + CACHE.allRows.length + ' שיחות. טוען RISK…');
        return fetchAllPaged(REVIEWS_TABLE, 'id, time_key, phone, line_num, snippet_text, pattern_key, status, reviewed_at, reviewed_by', 'time_key');
      })
      .then(function(allRisk){
        buildRiskCache(allRisk || []);
        markRowsWithRisk();
        setStatusOk('RISK נטען (צמדים=' + CACHE.riskKeySet.size + '). טוען דגלי הסתרה…');
        return fetchAllPaged(FLAGS_TABLE, 'time_key, phone, is_hidden', 'time_key');
      })
      .then(function(allFlags){
        (allFlags || []).forEach(function(fr){
          CACHE.flagsMap.set(keyOf(fr.time_key, fr.phone), { is_hidden: !!fr.is_hidden });
        });
        setStatusOk('דגלי הסתרה נטענו (' + CACHE.flagsMap.size + '). טוען סטטוסים…');
        return fetchAllPaged(USERS_INFO_TABLE, 'phone, status', 'phone');
      })
      .then(function(allInfo){
        (allInfo || []).forEach(function(ir){
          putInfoStatus(ir.phone, ir.status);
        });
        CACHE.loaded = true;
        setStatusOk('טעינה ראשונית הושלמה. סלקציות כעת מקומיות.');
      })
      .catch(function(e){
        setStatusErr('שגיאת טעינה: ' + (e && e.message ? e.message : e));
        throw e;
      });
  }

  function normalizeDateInput(s){
    var v = String(s || '').trim();
    if (!v) return '';
    // support YYYY-MM-DD -> YYYY.MM.DD
    var m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m) return m[1] + '.' + m[2] + '.' + m[3];
    return v;
  }

  function getFilteredRowsFromCache(){
    var phoneNeedle = (el.fPhone.value || '').trim();
    var nameNeedle  = (el.fName.value  || '').trim();
    var f = normalizeDateInput(el.fFrom.value || '');
    var t = normalizeDateInput(el.fTo.value   || '');

    var fromTime = isYL(f) ? (f + '-00.00.00') : null;
    var toTime   = isYL(t) ? (t + '-23.59.59') : null;

    var pnLow = phoneNeedle ? phoneNeedle.toLowerCase() : '';
    var nnLow = nameNeedle  ? nameNeedle.toLowerCase()  : '';

    var out = [];
    (CACHE.allRows || []).forEach(function(r){
      if (r && r._forceRisk){ out.push(r); return; }

      if (pnLow && String(r.phone || '').toLowerCase().indexOf(pnLow) === -1) return;
      if (nnLow && String(r.name  || '').toLowerCase().indexOf(nnLow) === -1) return;
      if (fromTime && String(r.time_key||'') < fromTime) return;
      if (toTime   && String(r.time_key||'') > toTime)   return;

      out.push(r);
    });

    out.sort(function(a,b){
      var ta = String(a.time_key||''), tb = String(b.time_key||'');
      if (ta < tb) return -1;
      if (ta > tb) return 1;
      var pa = String(a.phone||''), pb = String(b.phone||'');
      if (pa < pb) return -1;
      if (pa > pb) return 1;
      return 0;
    });

    return out;
  }

  function rerenderFromCache(){
    if (!CACHE.loaded){
      setStatusOk('הנתונים עדיין לא נטענו. לחץ "טען".');
      return;
    }
    setStatusErr('');
    setStatusOk('מרנדר מקומית…');
    var talkKind = (el.fKind.value || '').trim();
    var rows = getFilteredRowsFromCache();

    ensureUsersInformationForRows(rows).then(function(){
      return render(rows, CACHE.flagsMap, CACHE.infoMap, talkKind);
    }).then(function(info){
      el.countInfo.textContent = 'מציג ' + (info.patientsCount||0) + ' מטופלים · ' + (info.shownCount||0) + ' שיחות פתוחות · ' + (info.hiddenCount||0) + ' שיחות מוסתרות';
      setStatusOk('מוכן.');
    }).catch(function(e){
      setStatusErr('שגיאת רינדור: ' + (e && e.message ? e.message : e));
    });
  }
  var LS_STATUS_KEY = 'uvr_status_filter';
  var STATUS_TITLE_MAP = {
    "":  "כל הסוגים",
    "1": "השיחות של המטפל הוירטואלי",
    "2": "השיחות של מדריך הקורס",
    "3": "השיחות של המטפל הוירטואלי + מדריך הקורס",
    "4": "השיחות של טסט"
  };

  function updateTitlesFromStatus() {
    var kind = (el.fKind && el.fKind.value) ? el.fKind.value : "";
    var fullTitle = Object.prototype.hasOwnProperty.call(STATUS_TITLE_MAP, kind) ? STATUS_TITLE_MAP[kind] : "כל הסוגים";
    document.title = fullTitle;
    var h2 = $("pageTitle");
    if (h2) h2.textContent = fullTitle;
  }

  try {
    if (window.localStorage) {
      var savedStatus = localStorage.getItem(LS_STATUS_KEY);
      if (savedStatus !== null) el.fKind.value = savedStatus;
    }
  } catch(e) {}

  var LIMIT = 100;

  function isYL(s){
    var v = String(s || '').trim();
    if (!v) return false;
    // accept YYYY.MM.DD or YYYY-MM-DD
    if (/^\d{4}\.\d{2}\.\d{2}$/.test(v)) return true;
    if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return true;
    return false;
  }

  function todayYMD(){
    // Returns YYYY.MM.DD to match time_key prefix format
    try{
      var d = new Date();
      var y = d.getFullYear();
      var m = String(d.getMonth()+1).padStart(2,'0');
      var day = String(d.getDate()).padStart(2,'0');
      return y + '.' + m + '.' + day;
    }catch(e){
      return '';
    }
  }

  // תווית למצב משתמש (מטפל/מדריך) שמגיע מ-users_information.status
  function statusLabel(statusVal){
    if (statusVal == null) return 'לא ידוע';
    var s = String(statusVal).trim();
    if (!s) return 'לא ידוע';

    // התאמות נפוצות (שמור גמיש - לא מניח קידוד יחיד)
    var low = s.toLowerCase();
    if (s === '1' || low === 'therapist' || low === 't') return 'מטפל וירטואלי';
    if (s === '3' || low === 'mentor'    || low === 'm') return 'מדריך קורס';

    // אם כבר הגיע בעברית - נשאיר בקירוב תקין
    if (s.indexOf('מטפל') !== -1)  return 'מטפל וירטואלי';
    if (s.indexOf('מדריך') !== -1) return 'מדריך קורס';

    return s;
  }

  function stripAllHtml(raw){
    var s = String(raw==null?'':raw);
    s = s.replace(/<br\s*\/?>(?=\s*)/gi, '\n');
    s = s.replace(/<\/?.*?>/g, '');
    return s;
  }
  function normalizeWs(raw){
    return String(raw==null?'':raw)
      .replace(/[\u200e\u200f\u202a-\u202e\u200b]/g,'')
      .replace(/\u00a0/g,' ')
      .replace(/\r/g,'')
      .replace(/[ \t]+\n/g, '\n')
      .replace(/\n{2,}/g, '\n');
  }
  function cleanTalk(raw){ return normalizeWs(stripAllHtml(raw)); }

  function b64Enc(str){ try{ return btoa(unescape(encodeURIComponent(String(str||'')))); }catch(e){ return ''; } }
  function b64Dec(str){ try{ return decodeURIComponent(escape(atob(String(str||'')))); }catch(e){ return ''; } }

  function sliceSummaryFromLastMarker(summary){
    var s = String(summary||'');
    if (!s) return s;
    var lines = s.split(/\n/);
    var lastIdx = -1;
    var rx = /^\s*(\d{2}\/\d{2}\/\d{4})\s*-\s*(\d{8}T\d{6}Z)\s*$/;
    for (var i=0;i<lines.length;i++){
      if (rx.test(lines[i])) lastIdx = i;
    }
    if (lastIdx === -1) return s;
    return lines.slice(lastIdx).join('\n');
  }

  function timeKeyToHuman(k){
    var s = String(k||'');
    var parts = s.split('-');
    if (parts.length === 2){
      var d = parts[0];
      var hhmmssms = parts[1].replace(/\./g, ':');
      return hhmmssms + '  ' + d;
    }
    return s;
  }

  function escapeRegExp(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  function ilStamp(ts){
    try{ return new Date(ts).toLocaleString('he-IL', { timeZone: 'Asia/Jerusalem', hour12: false }); }
    catch(e){ return ts; }
  }
  function nowISO(){ return new Date().toISOString(); }
  function normPhone(p){
    var s = String(p == null ? '' : p);
    // keep digits only
    var d = s.replace(/\D+/g,'');
    if (!d) return s.trim();

    // normalize Israel +972XXXXXXXXX -> 0XXXXXXXXX when possible
    if (d.startsWith('972') && d.length >= 11){
      var rest = d.slice(3);
      if (rest.length === 9) return '0' + rest;
      if (rest.length === 10 && rest.startsWith('0')) return rest;
      return rest;
    }

    // normalize Israel numbers missing leading 0 (e.g. 526010111 -> 0526010111)
    if (d.length === 9){
      return '0' + d;
    }

    return d;
  }

  function keyOf(time_key, phone){ return String(time_key||'') + '|' + normPhone(phone); }

  function showInlineMsg(talkElem, msg){
    if (!talkElem) return;
    var box = talkElem.querySelector('.inline-msg');
    if (!box){
      box = document.createElement('div');
      box.className = 'inline-msg';
      var head = talkElem.querySelector('.head');
      if (head && head.nextSibling) talkElem.insertBefore(box, head.nextSibling);
      else talkElem.appendChild(box);
    }
    box.textContent = msg;
  }

  // -------------------------------
  // דיאלוג לפורמטים שונים (שם מטופל/ת, "המטפל:", Q/A, וכו')
  // -------------------------------
  function toDialogLines(name, rawText){
    var patient = (name && String(name).trim()) ? String(name).trim() : 'מטופל/ת';

    var tsPrefix = '\\s*(?:\\[[^\\]]*\\]\\s*)?';
    var rxPatientName = new RegExp('^' + tsPrefix + escapeRegExp(patient) + ':\\s*');
    var rxTher = new RegExp('^' + tsPrefix + 'המטפל:\\s*');
    var rxQ = new RegExp('^' + tsPrefix + 'Q:\\s*', 'i');
    var rxA = new RegExp('^' + tsPrefix + 'A:\\s*', 'i');
    var rxGenericPatient = new RegExp('^' + tsPrefix + '(?:המטופל|מטופל\\/ת|מטופל):\\s*');
    var rxGenericTher = new RegExp('^' + tsPrefix + '(?:המטפל):\\s*');

    var lines = String(rawText||'').split(/\n/);
    var out = [];

    for (var i=0;i<lines.length;i++){
      var s = String(lines[i]||'');

      if (rxPatientName.test(s)){ out.push({ speaker:'patient', body:s.replace(rxPatientName,'') }); continue; }
      if (rxTher.test(s)){ out.push({ speaker:'therapist', body:s.replace(rxTher,'') }); out.push({ speaker:'spacer' }); continue; }
      if (rxQ.test(s)){ out.push({ speaker:'patient', body:s.replace(rxQ,'') }); continue; }
      if (rxA.test(s)){ out.push({ speaker:'therapist', body:s.replace(rxA,'') }); out.push({ speaker:'spacer' }); continue; }
      if (rxGenericPatient.test(s)){ out.push({ speaker:'patient', body:s.replace(rxGenericPatient,'') }); continue; }
      if (rxGenericTher.test(s)){ out.push({ speaker:'therapist', body:s.replace(rxGenericTher,'') }); out.push({ speaker:'spacer' }); continue; }

      if (/^\s*שאלה:\s*/.test(s)){ out.push({ speaker:'patient', body:s.replace(/^\s*שאלה:\s*/,'') }); continue; }
      if (/^\s*תשובה:\s*/.test(s)){ out.push({ speaker:'therapist', body:s.replace(/^\s*תשובה:\s*/,'') }); out.push({ speaker:'spacer' }); continue; }

      out.push({ speaker:'text', body:s });
    }
    return { patient: patient, lines: out };
  }

  // -------------------------------
  // RISK: מגיע רק מ-risk_reviews (בלי Regex)
  // -------------------------------
  function loadRiskRows(time_key, phone){
    if (!time_key || !phone) return Promise.resolve([]);
    if (CACHE && CACHE.loaded){
      return Promise.resolve(CACHE.riskMap.get(keyOf(time_key, phone)) || []);
    }
    // fallback (לא אמור לקרות אחרי טעינה ראשונית)
    return supa.from(REVIEWS_TABLE)
      .select('line_num, id, snippet_text, pattern_key, status, reviewed_at, reviewed_by')
      .eq('time_key', time_key)
      .eq('phone', phone)
      .then(function(res){
        if (res.error) return [];
        return res.data || [];
      });
  }

  function hashStr(str){
    var h=5381, i=0, cc;
    for (i=0;i<str.length;i++){ cc=str.charCodeAt(i); h=((h<<5)+h) ^ cc; }
    return (h>>>0).toString(16);
  }

  // מנסים לעגן כל RISK בתוך שורת מטופל כדי לאפשר "פתח את הסיכון"
  function bindRiskToDialog(dialogLines, talkDomId, riskRows){
    var hits = [];
    var used = new Set();

    for (var idx=0; idx<dialogLines.length; idx++){
      var ln = dialogLines[idx];
      if (ln.speaker !== 'patient') continue;

      var txt = String(ln.body || '');
      for (var r=0; r<riskRows.length; r++){
        var rr = riskRows[r];
        var needle = String(rr.snippet_text || '').trim();
        if (!needle) continue;

        // אם כבר שיבצנו את אותו hash בעוגן – דלג
        var sh = rr.risk_id || (hashStr(needle + '|' + (rr.pattern_key||'')));
        if (used.has(sh)) continue;

        if (txt.indexOf(needle) !== -1){
          var targetId = 'line-' + talkDomId + '-' + idx + '-' + String(sh).slice(0,6);
          ln._anchorId = targetId;
          hits.push({
            hash: sh,
            pattern_key: rr.pattern_key || '',
            targetId: targetId,
            lineIndex: idx,
            matchText: needle,
            status: rr.status || 'pending',
            reviewed_at: rr.reviewed_at || null,
            reviewed_by: rr.reviewed_by || ''
          });
          used.add(sh);
        }
      }
    }

    // RISK שלא נמצא בטקסט (למשל חוסר התאמה) – עדיין יחושבו להתרעות למעלה
    for (var r2=0; r2<riskRows.length; r2++){
      var rr2 = riskRows[r2];
      var needle2 = String(rr2.snippet_text || '').trim();
      if (!needle2) continue;
      var sh2 = rr2.risk_id || (hashStr(needle2 + '|' + (rr2.pattern_key||'')));
      if (used.has(sh2)) continue;
      hits.push({
        hash: sh2,
        pattern_key: rr2.pattern_key || '',
        targetId: '',
        lineIndex: -1,
        matchText: needle2,
        status: rr2.status || 'pending',
        reviewed_at: rr2.reviewed_at || null,
        reviewed_by: rr2.reviewed_by || ''
      });
      used.add(sh2);
    }

    return hits;
  }

  function renderDialogHtml(patientName, dialogLines, hits){
    var html = [];

    function hitForLine(i){
      for (var j=0;j<hits.length;j++){
        if (hits[j].lineIndex === i) return hits[j];
      }
      return null;
    }

    for (var i=0;i<dialogLines.length;i++){
      var ln = dialogLines[i];

      if (ln.speaker === 'patient'){
        var body = escapeHtml(ln.body || '');
        var h = hitForLine(i);

        if (h && h.matchText){
          var rxm = new RegExp(escapeRegExp(h.matchText), 'u');
          var cls = 'risk';
          var note = '';
          var btn = '';

          if (String(h.status||'') === 'reviewed'){
            cls += ' reviewed';
            var stamp = h.reviewed_at ? ilStamp(h.reviewed_at) : '';
            note = ' <span class="note-yellow">(המטפל בדק' + (stamp?(' בתאריך ' + escapeHtml(stamp)):'') + (h.reviewed_by?(', ' + escapeHtml(h.reviewed_by)):'') + ')</span>';
            btn = ' <button class="btn-unreview-inline" data-hash="'+escapeHtml(h.hash)+'" data-pattern="'+escapeHtml(h.pattern_key)+'" title="בטל סימון">בטל סימון</button>';
          } else {
            btn = ' <button class="btn-review-inline" data-hash="'+escapeHtml(h.hash)+'" data-pattern="'+escapeHtml(h.pattern_key)+'" data-snippet="'+escapeHtml(h.matchText)+'" title="סמן כטופל">סמן כטופל</button>';
          }

          body = body.replace(rxm, '<mark class="' + cls + '" data-hash="'+escapeHtml(h.hash)+'" data-pattern="'+escapeHtml(h.pattern_key)+'">$&</mark>' + note + btn);
        }

        html.push('<div class="line speaker"><span class="speaker speaker-patient">' + escapeHtml(patientName) + ':</span> <span id="' + escapeHtml(ln._anchorId||'') + '">' + body + '</span></div>');
      } else if (ln.speaker === 'therapist'){
        html.push('<div class="line speaker"><span class="speaker speaker-therapist">המטפל:</span> ' + escapeHtml(ln.body || '') + '</div>');
      } else if (ln.speaker === 'spacer'){
        html.push('<div class="line-spacer"></div>');
      } else {
        html.push('<div class="line">' + escapeHtml(ln.body || '') + '</div>');
      }
    }

    return html.join('\n');
  }

  function queryPage(forceReload){
    if (CACHE.loaded && !forceReload){
      rerenderFromCache();
      return;
    }
    loadAllDataFromServer().then(function(){
      rerenderFromCache();
    }).catch(function(){});
  }

  function render(rows, flagsMap, infoMap, talkKind){
    return new Promise(function(resolve){
      var parts = [], alerts = [];
      var hiddenCount = 0, shownCount = 0;
      var patientsShown = new Set();

      function isRowAllowed(row){
        // שיחה שנוספה בגלל RISK עוקפת את כל סינון הסטטוס
        if (row && row._forceRisk) return true;
        if (!talkKind) return true;
        var phoneKey = normPhone(row.phone);
        if (!phoneKey) return false;
        var info = infoMap.get(phoneKey);
        if (!info || info.status == null) return false;
        var sVal = parseInt(info.status, 10);
        var kVal = parseInt(talkKind, 10);
        if (!isFinite(kVal)) return true;
        return sVal === kVal;
      }

      function nextRow(i){
        if (i >= rows.length){
          var totalHits = alerts.reduce(function(sum, a){ return sum + (a.items ? a.items.length : 0); }, 0);

          el.out.innerHTML = parts.join('') || '<div class="card hint">אין תוצאות.</div>';

          if (alerts.length){
            var top = ['<div class="alertbar"><h3>⚠️ נמצאו ' + totalHits + ' ביטויי סיכון ב-' + alerts.length + ' שיחות</h3>'];
            for (var a=0;a<alerts.length;a++){
              var AA = alerts[a];
              top.push('<div class="alertitem">');
              top.push('<div><strong>' + escapeHtml(AA.name) + '</strong> · ' + escapeHtml(AA.phone) + '</div>');
              top.push('<div class="when">' + escapeHtml(AA.time) + '</div><div>');
              for (var z=0; z<AA.items.length; z++){
                var it = AA.items[z];
                top.push('<span class="pill mono" title="' + escapeHtml(it.text) +'">'+ escapeHtml(it.text) +'</span> ');
                if (it.targetId){
                  top.push('<button class="btn-open-risk" data-act="goto" data-target="' + escapeHtml(it.targetId) + '">פתח את הסיכון</button> ');
                } else {
                  top.push('<button class="btn-open-risk" disabled title="לא נמצא עוגן בטקסט">פתח את הסיכון</button> ');
                }
              }
              top.push('</div></div>');
            }
            top.push('</div>');
            el.alertHost.innerHTML = top.join('');
            el.alertHost.querySelectorAll('button[data-act="goto"]').forEach(function(btn){
              btn.addEventListener('click', function(){
                var id = btn.getAttribute('data-target');
                var node = id ? document.getElementById(id) : null;
                if (!node) return;
                node.scrollIntoView({behavior:'smooth', block:'center'});
                node.classList.add('target-blink');
                setTimeout(function(){ node.classList.remove('target-blink'); }, 1300);
              });
            });
          } else {
            el.alertHost.innerHTML = '';
          }

          resolve({ hiddenCount:hiddenCount, shownCount:shownCount, patientsCount: patientsShown.size });
          return;
        }

        var r = rows[i];
        if (!isRowAllowed(r)){ nextRow(i+1); return; }

        var talkClean = cleanTalk(r.last_talk_tzvira || '');
        var parsed = toDialogLines(r.name, talkClean);
        var talkDomId = (r.time_key || '').replace(/[^0-9]/g,'') || Math.random().toString(36).slice(2);

        loadRiskRows(r.time_key, r.phone).then(function(riskRows){
          var hits = bindRiskToDialog(parsed.lines, talkDomId, riskRows);

          // open risks for alerts (status != reviewed)
          var notRev = [];
          for (var h=0; h<hits.length; h++){
            if (String(hits[h].status||'') !== 'reviewed') notRev.push(hits[h]);
          }

          var k = keyOf(r.time_key, r.phone);
          var flag = flagsMap.get(k);
          var isHidden = !!(flag && flag.is_hidden);

          if (!isHidden && notRev.length){
            var items = [];
            for (var nn=0; nn<notRev.length; nn++){
              var hh2 = notRev[nn];
              items.push({
                text: hh2.matchText,
                hash: hh2.hash,
                pattern_key: hh2.pattern_key,
                targetId: hh2.targetId || ''
              });
            }
            alerts.push({
              name: r.name || 'מטופל/ת',
              phone: r.phone || '',
              time: timeKeyToHuman(r.time_key),
              items: items
            });
          }

          var nameHtml  = '<span class="patient-name">' + escapeHtml(r.name || 'מטופל/ת') + '</span>';
          var phoneHtml = '<span class="patient-phone">' + escapeHtml(r.phone || '') + '</span>';
          var btnLabel  = isHidden ? 'הצג שיחה' : 'הסתר שיחה';

          var rawHasContent = !!(r.summarized_linked_talk && String(r.summarized_linked_talk).trim());

          var headParts = [];
          headParts.push('<div class="head">');
          headParts.push('<div class="head-name">', nameHtml, '</div>');
          headParts.push('<div class="head-phone">', phoneHtml, '</div>');

          var kindTxt = 'לא ידוע';
          try{
            var info2 = infoMap.get(normPhone(r.phone));
            if (info2 && info2.status != null && String(info2.status).trim() !== ''){
              kindTxt = statusLabel(info2.status);
            } else {
              var fk = (el && el.fKind ? String(el.fKind.value||'').trim() : '');
              if (fk && fk !== 'all'){
                kindTxt = statusLabel(fk);
              }
            }
          } catch(e){}
          if (r && r._forceRisk){
            kindTxt = 'RISK override · ' + kindTxt;
          }
          headParts.push('<div class="meta why">', escapeHtml(kindTxt), '</div>');

          if (r && r._forceRisk){
            headParts.push('<div class="meta"><span class="pill">RISK override</span></div>');
          }

          var canToggle = (isHidden || (!isHidden && notRev.length === 0));
          var canSumm   = (!isHidden && notRev.length === 0);
          var canRaw    = (!isHidden && rawHasContent);

          if (canToggle) {
            headParts.push(
              '<button class="btn-toggle btn-state-active" data-time="', escapeHtml(r.time_key),
              '" data-phone="', escapeHtml(r.phone||''),
              '" data-name="', escapeHtml(r.name||''),
              '" data-hidden="', (isHidden?'1':'0'),
              '" data-notrev="', (notRev.length), '">', btnLabel, '</button>'
            );
          } else {
            headParts.push('<button class="btn-placeholder">' + btnLabel + '</button>');
          }

          if (canSumm) {
            headParts.push('<button class="btn-summarized_linked_talk btn-state-active" data-notrev="0">הצג מקוצרת</button>');
          } else {
            headParts.push('<button class="btn-placeholder">הצג מקוצרת</button>');
          }

          if (canRaw) {
            headParts.push('<button class="btn-raw-summary btn-state-active" title="הצג את summarized_linked_talk כפי שהוא">הצג שיחות קודמות</button>');
          } else {
            headParts.push('<button class="btn-placeholder">הצג שיחות קודמות</button>');
          }

          headParts.push('<span class="meta mono">', escapeHtml(timeKeyToHuman(r.time_key)), '</span>');
          headParts.push('<button class="btn-home" title="חזרה למסך הראשון">חזרה למסך הראשון</button>');
          headParts.push('</div>');

          parts.push('<div class="talk" data-time="' + escapeHtml(r.time_key) + '" data-phone="' + escapeHtml(r.phone||'') + '" data-name="'+escapeHtml(r.name||'')+'">');
          parts.push(headParts.join(''));

          if (isHidden){
            hiddenCount++;
          } else {
            shownCount++;
            if (r.phone) patientsShown.add(String(r.phone).trim());

            var dialogHtml = renderDialogHtml(parsed.patient, parsed.lines, hits);
            parts.push('<div class="body">' + dialogHtml + '</div>');

            var sumRaw = (r.summarized_linked_talk || '').trim();
            var sumCut = sliceSummaryFromLastMarker(sumRaw);
            var sumHtml = sumCut ? escapeHtml(sumCut) : '<span class="empty">אין סיכום שיחה.</span>';
            var sumRawB64 = b64Enc(sumRaw);
            parts.push('<div class="summarized_linked_talk" data-raw-b64="'+escapeHtml(sumRawB64)+'">'+ sumHtml +'</div>');
          }

          parts.push('</div>');
          nextRow(i+1);
        });
      }

      nextRow(0);
    });
  }

  // האזנות על רשימת התוצאות
  el.out.addEventListener('click', function(ev){
    var btnHome = ev.target.closest('.btn-home');
    if (btnHome){
      el.fPhone.value=''; el.fName.value=''; el.fFrom.value=''; el.fTo.value='';
      queryPage(true);
      window.scrollTo({top:0, behavior:'smooth'});
      return;
    }

    var btnToggle = ev.target.closest('.btn-toggle');
    if (btnToggle){
      var talkElem = btnToggle.closest('.talk');
      var time_key = btnToggle.getAttribute('data-time');
      var phone    = btnToggle.getAttribute('data-phone');
      var name     = btnToggle.getAttribute('data-name') || null;
      var isHidden = btnToggle.getAttribute('data-hidden') === '1';
      var notRevCount = parseInt(btnToggle.getAttribute('data-notrev')||'0',10);

      if (!isHidden && notRevCount > 0){
        showInlineMsg(talkElem, 'לא ניתן להסתיר שיחה כל עוד קיימים ביטויי סיכון שלא טופלו.');
        return;
      }

      var payload = { time_key: time_key, phone: phone, is_hidden: !isHidden, toggled_by: 'viewer_default', patient_name: name };

      supa.from(FLAGS_TABLE)
          .upsert(payload, { onConflict: 'time_key,phone' })
          .then(function(res2){
            if (res2.error){
              showInlineMsg(talkElem, 'שגיאה בעדכון מצב השיחה: ' + (res2.error.message || 'unknown'));
              return;
            }
            if (CACHE && CACHE.loaded){
              CACHE.flagsMap.set(keyOf(time_key, phone), { is_hidden: !isHidden });
              rerenderFromCache();
            } else {
              queryPage(true);
            }
          });
      return;
    }

    var btnSumm = ev.target.closest('.btn-summarized_linked_talk');
    if (btnSumm){
      var talk = btnSumm.closest('.talk');
      var body = talk.querySelector('.body');
      var sum  = talk.querySelector('.summarized_linked_talk');
      if (body && sum){
        var showingFull = (body.style.display !== 'none');
        if (showingFull){
          body.style.display = 'none';
          sum.style.display  = 'block';
          btnSumm.textContent = 'הצג מלאה';
          btnSumm.classList.add('btn-selected');
        } else {
          sum.style.display  = 'none';
          body.style.display = 'block';
          btnSumm.textContent = 'הצג מקוצרת';
          btnSumm.classList.remove('btn-selected');
        }
      }
      return;
    }

    var btnRaw = ev.target.closest('.btn-raw-summary');
    if (btnRaw){
      var talk2 = btnRaw.closest('.talk');
      var body2 = talk2.querySelector('.body');
      var sum2  = talk2.querySelector('.summarized_linked_talk');
      if (!sum2) return;

      var showingRaw = btnRaw.getAttribute('data-showing') === '1';
      if (!showingRaw){
        var rawB64 = sum2.getAttribute('data-raw-b64') || '';
        var rawTxt = b64Dec(rawB64);
        if (!rawTxt){ showInlineMsg(talk2, 'אין תוכן סיכום שיחות'); return; }

        if (body2) body2.style.display = 'none';
        sum2.style.display = 'block';
        sum2.textContent   = rawTxt;
        btnRaw.textContent = 'הצג שיחה';
        btnRaw.setAttribute('data-showing','1');
        btnRaw.classList.add('btn-selected');
      } else {
        if (sum2)  sum2.style.display  = 'none';
        if (body2) body2.style.display = 'block';
        btnRaw.textContent = 'הצג שיחות קודמות';
        btnRaw.setAttribute('data-showing','0');
        btnRaw.classList.remove('btn-selected');
      }
      return;
    }

    // --- RISK actions: mark reviewed / unreviewed (UPDATE by PK: id,time_key,phone,line_num)
    var btnReview = ev.target.closest('.btn-review-inline');
    if (btnReview){
      var talkElem2 = btnReview.closest('.talk');
      var time_key2 = talkElem2 ? talkElem2.getAttribute('data-time') : null;
      var phone2    = talkElem2 ? talkElem2.getAttribute('data-phone') : null;

      var riskId   = btnReview.getAttribute('data-risk-id') || '';
      var lineNumS = btnReview.getAttribute('data-line-num');
      var lineNum  = (lineNumS == null || String(lineNumS).trim()==='') ? null : parseInt(lineNumS, 10);

      if (!riskId || !time_key2 || !phone2 || lineNum == null || !isFinite(lineNum)){
        showInlineMsg(talkElem2, 'שגיאה: חסרים מזהים לסימון (id/time_key/phone/line_num).');
        return;
      }

      supa.from(REVIEWS_TABLE)
          .update({ status:'reviewed', reviewed_at: nowISO(), reviewed_by: null })
          .eq('id', riskId)
          .eq('time_key', time_key2)
          .eq('phone', phone2)
          .eq('line_num', lineNum)
          .then(function(res3){
            if (res3.error){
              showInlineMsg(talkElem2, 'שגיאה בסימון: ' + (res3.error.message || 'unknown'));
              return;
            }
            // Update cache if present
            try{
              if (CACHE && CACHE.loaded){
                var kk = keyOf(time_key2, phone2);
                var arr = CACHE.riskMap.get(kk) || [];
                for (var i=0;i<arr.length;i++){
                  if (String(arr[i].id||'')===String(riskId) && parseInt(arr[i].line_num,10)===lineNum){
                    arr[i].status = 'reviewed';
                    arr[i].reviewed_at = new Date().toISOString();
                    arr[i].reviewed_by = null;
                  }
                }
                CACHE.riskMap.set(kk, arr);
                rerenderFromCache();
                return;
              }
            } catch(e){}
            queryPage(true);
          });
      return;
    }

    var btnUnreview = ev.target.closest('.btn-unreview-inline');
    if (btnUnreview){
      var talkElem3 = btnUnreview.closest('.talk');
      var time_key3 = talkElem3 ? talkElem3.getAttribute('data-time') : null;
      var phone3    = talkElem3 ? talkElem3.getAttribute('data-phone') : null;

      var riskId3   = btnUnreview.getAttribute('data-risk-id') || '';
      var lineNumS3 = btnUnreview.getAttribute('data-line-num');
      var lineNum3  = (lineNumS3 == null || String(lineNumS3).trim()==='') ? null : parseInt(lineNumS3, 10);

      if (!riskId3 || !time_key3 || !phone3 || lineNum3 == null || !isFinite(lineNum3)){
        showInlineMsg(talkElem3, 'שגיאה: חסרים מזהים לביטול סימון (id/time_key/phone/line_num).');
        return;
      }

      supa.from(REVIEWS_TABLE)
          .update({ status:'pending' })
          .eq('id', riskId3)
          .eq('time_key', time_key3)
          .eq('phone', phone3)
          .eq('line_num', lineNum3)
          .then(function(res4){
            if (res4.error){
              showInlineMsg(talkElem3, 'שגיאה בביטול סימון: ' + (res4.error.message || 'unknown'));
              return;
            }
            // Update cache if present
            try{
              if (CACHE && CACHE.loaded){
                var kk3 = keyOf(time_key3, phone3);
                var arr3 = CACHE.riskMap.get(kk3) || [];
                for (var j=0;j<arr3.length;j++){
                  if (String(arr3[j].id||'')===String(riskId3) && parseInt(arr3[j].line_num,10)===lineNum3){
                    arr3[j].status = 'pending';
                  }
                }
                CACHE.riskMap.set(kk3, arr3);
                rerenderFromCache();
                return;
              }
            } catch(e){}
            queryPage(true);
          });
      return;
    }
  });

  el.fKind.addEventListener('change', function(){
    try {
      if (window.localStorage) localStorage.setItem(LS_STATUS_KEY, el.fKind.value || '');
    } catch(e) {}
    updateTitlesFromStatus();
    if (CACHE && CACHE.loaded){ rerenderFromCache(); } else { queryPage(true); }
  });

  el.btnRun.onclick   = function(){ queryPage(true); };
  el.btnClear.onclick = function(){
    el.fPhone.value=''; el.fName.value=''; el.fFrom.value=''; el.fTo.value='';
    if (CACHE && CACHE.loaded){ rerenderFromCache(); } else { queryPage(true); }
  };

  updateTitlesFromStatus();

  // init אחרי שה-DOM מוכן (למקרה של race)
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ queryPage(true); });
  } else {
    queryPage(true);
  }
})();
</script>
</body>
</html>
