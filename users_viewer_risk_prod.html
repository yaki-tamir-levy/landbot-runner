<!doctype html>
<!-- VERSION: 2026-01-16 STAGE3-FIX5 A (RISK STATUS UPDATE + NOTE REQUIRED + INLINE ERROR NEAR TEXTAREA) -->
<html lang="he" dir="rtl">
<head>
  <script>
  (function () {
    // אותה הסיסמה כמו בקובץ launcher.html
    const APP_PASSWORD   = "yon1234";
    const EXPECTED_TOKEN = "ok-" + btoa(APP_PASSWORD);

    try {
      const token = sessionStorage.getItem("riskAppAuth");

      // אם אין טוקן תקין – מחזירים למסך הכניסה
      if (token !== EXPECTED_TOKEN) {
        window.location.href = "launcher.html";
        return;
      }

      // אם הגענו לכאן – הטוקן תקין עבור הכניסה הנוכחית.
      // מנקים אותו מיד כדי שכל טעינה מחדש תדרוש סיסמה מחדש.
      sessionStorage.removeItem("riskAppAuth");
    } catch (e) {
      window.location.href = "launcher.html";
    }
  })();
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>כל הסוגים</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.js"></script>
  <style>
    :root { --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --divider:#e5e7eb; --danger:#7f1d1d; --ok:#065f46; --hi:#fde68a; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1000px;margin:0 auto;padding:20px}
    h2{margin:0 0 12px 0; text-align:center}
    .card{background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:var(--muted)}
    input,button,select{background:#fff;color:var(--ink);border:1px solid var(--divider);border-radius:10px;padding:8px 10px}
    input::placeholder{color:#9ca3af}
    button{cursor:pointer}
    .controls{margin-bottom:10px}
    .table{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .talk{border:1px solid var(--divider);border-radius:12px;overflow:hidden;background:#fff}
    .head{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:8px;
  background:#fafafa;
  padding:10px 12px;
  border-bottom:1px solid #e5e7eb
}
.patient-name{font-weight:900;font-size:1.35rem;}
    .patient-phone{font-weight:400;font-size:0.9rem;color:var(--muted);}
    .btn-toggle,.btn-summarized_linked_talk,.btn-raw-summary,.btn-home{
      font-weight:700; border:2px solid #d1d5db; border-radius:10px; padding:8px 10px; background:#fff; min-width:140px; text-align:center
    }
    .btn-home{font-weight:400; min-width:150px; border-width:1px}
    .btn-selected{ background:#f3e8ff !important; border-color:#e9d5ff !important; }
    .btn-placeholder{ display:none; }
    .btn-state-active{ background:#dcfce7; border-color:#bbf7d0; }
    .btn-summarized_linked_talk[disabled]{opacity:.55; cursor:not-allowed}
    .btn-toggle:hover,.btn-summarized_linked_talk:hover,.btn-raw-summary:hover{box-shadow:0 0 0 2px #e5e7eb inset}
    .meta{color:var(--muted);font-weight:600}
    .body{padding:12px;white-space:pre-wrap;line-height:1.55}
    .summarized_linked_talk{padding:12px; white-space:pre-wrap; line-height:1.6; background:#fffaf0; border-top:1px dashed #f1d29b; display:none}
    .summarized_linked_talk .empty{color:#9ca3af}
    .hint{color:#6b7280;font-size:12px}
    .counts{margin-top:6px}
    mark.risk{ background:#ffe4e6; color:#000; padding:0 3px; border-radius:4px; font-weight:900; font-size:1.08em; }
    mark.risk.reviewed{ background:#d1fae5; color:#065f46; }
    .alertbar{border:1px solid #fecaca;background:#fee2e2;border-radius:12px;padding:10px 12px;margin:0 0 10px}
    .alertbar h3{margin:0 0 6px 0;color:#7f1d1d;font-size:14px}
    .alertitem{margin:6px 0;padding:8px 10px;border-radius:8px;background:#fff;border:1px dashed #fecaca}
    .alertitem .when{color:#7f1d1d;font-weight:700}
    .pill{ display:inline-block; padding:6px 12px; border-radius:999px; background:#ffe4e6; color:#000; font-size:16px; margin:2px 6px 2px 0; font-weight:900; border:1px solid #fecaca }
    .btn-open-risk{ font-weight:900; background:#ffd1d6; border:2px solid #fca5a5; padding:6px 12px; border-radius:10px; }
    .btn-open-risk:hover{ filter:brightness(0.98) }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .speaker{white-space:pre-wrap}
    .speaker-patient{font-weight:700}
    .speaker-therapist{font-weight:800;font-style:italic;font-size:1.05em}
    .line-spacer{height:1em}
    .target-blink{animation: blink 1.3s ease-in-out 1}
    @keyframes blink{ 0%{background:var(--hi)} 100%{background:transparent} }
    .risk-line{ border-radius:6px; padding:2px 4px; }
    .risk-line.open{ background:#ffe4e6; }
    .risk-line.checked{ background:#d1fae5; }
    .risk-badge{ display:inline-block; margin-inline-start:8px; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:900; border:1px solid #ddd; background:#fff; }
    .risk-badge.open{ border-color:#fecaca; background:#ffe4e6; }
    .risk-badge.checked{ border-color:#bbf7d0; background:#d1fae5; color:#065f46; }
    .risk-selected{ box-shadow:0 0 0 3px var(--hi) inset; }
    #statusBar{margin:10px 0}
    #statusBar .err{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:10px;border-radius:10px}
    #statusBar .ok{background:#dcfce7;border:1px solid #bbf7d0;color:#065f46;padding:10px;border-radius:10px}
    .inline-msg{margin:8px 12px;background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:8px 10px;border-radius:10px}
    .note-yellow{background:var(--hi); padding:0 4px; border-radius:4px}
    .btn-review-inline,.btn-unreview-inline{margin-inline-start:8px}
  
  .meta.why{ display:inline-block; margin:0 8px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }

    .risk-controls{ margin:6px 0 10px 0; padding:10px; border:1px solid var(--divider); border-radius:10px; background:#f9fafb; }
    .risk-controls .rc-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .risk-controls .rc-title{ font-weight:900; }
    .risk-controls .rc-btn{ font-weight:800; border:2px solid #d1d5db; border-radius:10px; padding:8px 10px; background:#fff; cursor:pointer; }
    .risk-controls .rc-btn:hover{ box-shadow:0 0 0 2px #e5e7eb inset; }
    .risk-controls .rc-btn.active{ background:#eef2ff; border-color:#c7d2fe; }
    .risk-controls textarea{ width:100%; min-height:70px; resize:vertical; }
    .risk-controls .rc-small{ color:var(--muted); font-size:12px; margin-top:6px; }
    .risk-controls .rc-status{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; background:#fff; font-weight:900; font-size:12px; }
    .risk-controls .rc-inline-msg{ margin-top:8px; background:#fee2e2; border:1px solid #fecaca; color:#7f1d1d; padding:8px 10px; border-radius:10px; font-weight:700; }


</style>
</head>
<body>
<div class="wrap">
  <h2 id="pageTitle">כל הסוגים</h2>
  <div class="hint" id="versionBadge" style="text-align:center; margin-top:-6px;">Version: 2026-01-16 STAGE3-FIX5 A <span id="vBadge" style="opacity:.75"></span></div>

  <div id="statusBar"></div>
  <div id="alertHost"></div>

  <div class="card controls">
    <div class="row">
      <div><label>Phone<br /><input id="fPhone" placeholder="+9725..." /></label></div>
      <div><label>Name<br /><input id="fName" placeholder="שם" /></label></div>
      <div><label>From (YYYY.MM.DD)<br /><input id="fFrom" placeholder="2025.11.01" /></label></div>
      <div><label>To (YYYY.MM.DD)<br /><input id="fTo" placeholder="2025.11.30" /></label></div>
      <div>
        <label>בחר סטטוס מטופל<br />
          <select id="fKind">
            <option value="" selected>הכל</option>
            <option value="1">מטפל וירטואלי</option>
            <option value="2">מדריך קורס</option>
            <option value="3">מטפל וירטואלי + מדריך בקורס</option>
            <option value="4">טסט</option>
          </select>
        </label>
      </div>
      <div><label>&nbsp;<br />
        <button id="btnRun">טען</button>
        <button id="btnClear">נקה</button>
      </label></div>
    </div>
    <div class="counts hint" id="countInfo"></div>
  </div>

  <div id="out" class="table"></div>
</div>

<script>
(function () {
  "use strict";

  function $(id){ return document.getElementById(id); }
  var el = {
    fPhone:$("fPhone"), fName:$("fName"), fFrom:$("fFrom"), fTo:$("fTo"), fKind:$("fKind"),
    btnRun:$("btnRun"), btnClear:$("btnClear"),
    out:$("out"), alertHost:$("alertHost"), statusBar:$("statusBar"), countInfo:$("countInfo")
  };

  // default date range: To = today (leave empty = ALL)
  try{
    if (!el.fTo.value || String(el.fTo.value).trim() === '2025.12.31'){
      el.fTo.value = todayYMD();
    }
  } catch(e){}

  function escapeHtml(s){ return String(s==null?'':s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }
  function setStatusErr(msg){ el.statusBar.innerHTML = msg ? '<div class="err">' + escapeHtml(msg) + '</div>' : ''; }
  function setStatusOk(msg){ el.statusBar.innerHTML = msg ? '<div class="ok">' + escapeHtml(msg) + '</div>' : ''; }

  window.addEventListener('error', function(e){
    var m = 'שגיאת סקריפט: ' + (e && e.message ? e.message : e);
    setStatusErr(m);
  });

  /* Supabase */
  var SUPABASE_URL      = "https://qcwimczsiuxkarwfiyai.supabase.co";
  var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjd2ltY3pzaXV4a2Fyd2ZpeWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1OTEwMzgsImV4cCI6MjA2OTE2NzAzOH0.zpMcORTD1voqZFj5QaPUc-EXf1juqnlTTP00jV6_TvI";
  var TABLE             = "users_tzvira";
  var REVIEWS_TABLE     = "risk_reviews";
  var FLAGS_TABLE       = "talk_read_flags";
  var USERS_INFO_TABLE  = "users_information";

  if (!window.supabase || !window.supabase.createClient){
    setStatusErr('ספריית Supabase לא נטענה (בדוק חיבור אינטרנט / חסימת CDN).');
    return;
  }
  var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


  // ------------------------------------------------------------
  // users_information.status backfill — at most one DB call per phone
  // Goal: never show "לא ידוע" if the status exists in users_information.
  // ------------------------------------------------------------
  var UI_STATUS_FETCH = new Map(); // normPhone(phone) -> Promise<any|null>

  function uiPhoneVariants(rawPhone){
    var s = String(rawPhone == null ? '' : rawPhone).trim();
    var digits = s.replace(/\D+/g,'');
    var set = new Set();
    if (digits) set.add(digits);

    if (digits.length === 9) set.add('0' + digits);
    if (digits.length === 10 && digits.charAt(0) === '0'){
      set.add(digits.slice(1));
      set.add('972' + digits.slice(1));
    }

    if (digits.startsWith('972') && digits.length >= 11){
      var rest = digits.slice(3);
      if (rest.length === 9) set.add('0' + rest);
      if (rest.length === 10) set.add(rest);
      set.add(rest);
    }

    if (/^\d+$/.test(s)) set.add(s);
    return Array.from(set).filter(function(x){ return x && String(x).trim() !== ''; });
  }

  function hasInfoStatus(phoneRaw){
    try{
      var info = CACHE && CACHE.infoMap ? CACHE.infoMap.get(normPhone(phoneRaw)) : null;
      return !!(info && info.status != null && String(info.status).trim() !== '');
    } catch(e){
      return false;
    }
  }

  function fetchUsersInformationStatusOnce(phoneRaw){
    var key = normPhone(phoneRaw);
    if (UI_STATUS_FETCH.has(key)) return UI_STATUS_FETCH.get(key);

    // if already present in cache, don't hit DB
    if (hasInfoStatus(phoneRaw)){
      var p0 = Promise.resolve(CACHE.infoMap.get(key).status);
      UI_STATUS_FETCH.set(key, p0);
      return p0;
    }

    var variants = uiPhoneVariants(phoneRaw);
    var orParts = variants.map(function(v){ return 'phone.eq.' + v; }).join(',');
    var p = supa.from(USERS_INFO_TABLE)
      .select('status, phone')
      .or(orParts)
      .limit(1)
      .then(function(res){
        var row = (res && res.data && res.data.length) ? res.data[0] : null;
        if (row && row.status != null && String(row.status).trim() !== ''){
          // backfill into CACHE.infoMap so filters/labels use it everywhere
          putInfoStatus(phoneRaw, row.status);
          return row.status;
        }
        return null;
      })
      .catch(function(){
        return null;
      });

    UI_STATUS_FETCH.set(key, p);
    return p;
  }

  function ensureUsersInformationForRows(rows){
    var uniq = new Map(); // key->raw
    (rows || []).forEach(function(r){
      var raw = (r && r.phone != null) ? r.phone : '';
      var k = normPhone(raw);
      if (!uniq.has(k)) uniq.set(k, raw);
    });

    var ps = [];
    uniq.forEach(function(raw, k){
      if (!hasInfoStatus(raw)){
        ps.push(fetchUsersInformationStatusOnce(raw));
      }
    });
    return Promise.all(ps);
  }
  function putInfoStatus(phoneRaw, statusVal){
    var status = statusVal;
    if (status == null || String(status).trim() === '') return;

    var s = String(phoneRaw == null ? '' : phoneRaw).trim();
    var digits = s.replace(/\D+/g,'');
    var keys = new Set();

    // normalized main key
    var norm = normPhone(phoneRaw);
    if (norm) keys.add(norm);

    if (digits) keys.add(digits);
    if (digits.length === 9) keys.add('0' + digits);
    if (digits.length === 10 && digits.charAt(0) === '0'){
      keys.add(digits.slice(1));
      keys.add('972' + digits.slice(1));
    }
    if (digits.startsWith('972') && digits.length >= 11){
      var rest = digits.slice(3);
      keys.add(rest);
      if (rest.length === 9) keys.add('0' + rest);
      if (rest.length === 10) keys.add(rest);
    }

    keys.forEach(function(k){
      if (!k) return;
      try{ CACHE.infoMap.set(k, { status: status }); } catch(e){}
    });
  }

  // ------------------------------------------------------------
  // CACHE MODE (Stage 1):
  // טעינה ראשונית מביאה *את כל הנתונים* (ללא סלקציה) כדי ששום RISK לא יחמוק.
  // לאחר מכן כל סלקציה היא מקומית (ללא רשת), ושיחות עם RISK עוקפות סלקציות.
  // ------------------------------------------------------------
  var CACHE = {
    loaded: false,
    allRows: [],
    flagsMap: new Map(),   // key(time,phone) -> {is_hidden}
    infoMap:  new Map(),   // phone -> {status}
    riskMap:  new Map(),   // key(time,phone) -> [riskRows]
    riskKeySet: new Set()  // key(time,phone)
  };

  function fetchAllPaged(tableName, selectCols, orderCol){
    var pageSize = 1000;
    var out = [];
    var offset = 0;

    function step(){
      var q = supa.from(tableName).select(selectCols);
      if (orderCol) q = q.order(orderCol, { ascending: true });
      return q.range(offset, offset + pageSize - 1).then(function(res){
        if (res.error){
          throw new Error('Fetch failed for ' + tableName + ': ' + (res.error.message || 'unknown'));
        }
        var data = res.data || [];
        out = out.concat(data);
        if (data.length < pageSize) return out;
        offset += pageSize;
        return step();
      });
    }
    return step();
  }

  
  function buildRiskCache(allRisk){
    CACHE.riskMap = new Map();   // id -> [riskRows]
    CACHE.riskKeySet = new Set();// ids that have risk
    (allRisk || []).forEach(function(rr){
      var tid = rr && rr.id ? String(rr.id) : '';
      if (!tid) return;
      CACHE.riskKeySet.add(tid);
      var arr = CACHE.riskMap.get(tid);
      if (!arr){ arr = []; CACHE.riskMap.set(tid, arr); }
      arr.push(rr);
    });
  }

  function markRowsWithRisk(){
    (CACHE.allRows || []).forEach(function(r){
      r._hasRisk   = CACHE.riskKeySet.has(String(r.id||''));
      // _forceRisk remains for overriding client-side filters (phone/name/date).
      r._forceRisk = !!r._hasRisk;
    });
  }

  function loadAllDataFromServer(){
    setStatusErr('');
    setStatusOk('טעינה ראשונית: מביא את כל השיחות ללא סלקציה…');

    CACHE.loaded = false;
    CACHE.allRows = [];
    CACHE.flagsMap = new Map();
    CACHE.infoMap = new Map();
    CACHE.riskMap = new Map();
    CACHE.riskKeySet = new Set();

    return fetchAllPaged(TABLE, 'id, time_key, phone, name, last_talk_tzvira, summarized_linked_talk', 'time_key')
      .then(function(allRows){
        CACHE.allRows = allRows || [];
        setStatusOk('נטענו ' + CACHE.allRows.length + ' שיחות. טוען RISK…');
        return fetchAllPaged(REVIEWS_TABLE, 'id, time_key, phone, line_num, status, reviewed_at, reviewer, name, review_notes, severity, match_method, risk_reasons, short_risk', 'id');
      })
      .then(function(allRisk){
        buildRiskCache(allRisk || []);
        markRowsWithRisk();
        setStatusOk('RISK נטען (צמדים=' + CACHE.riskKeySet.size + '). טוען דגלי הסתרה…');
        return fetchAllPaged(FLAGS_TABLE, 'time_key, phone, is_hidden', 'time_key');
      })
      .then(function(allFlags){
        (allFlags || []).forEach(function(fr){
          CACHE.flagsMap.set(keyOf(fr.time_key, fr.phone), { is_hidden: !!fr.is_hidden });
        });
        setStatusOk('דגלי הסתרה נטענו (' + CACHE.flagsMap.size + '). טוען סטטוסים…');
        return fetchAllPaged(USERS_INFO_TABLE, 'phone, status', 'phone');
      })
      .then(function(allInfo){
        (allInfo || []).forEach(function(ir){
          putInfoStatus(ir.phone, ir.status);
        });
        CACHE.loaded = true;
        setStatusOk('טעינה ראשונית הושלמה. סלקציות כעת מקומיות.');
      })
      .catch(function(e){
        setStatusErr('שגיאת טעינה: ' + (e && e.message ? e.message : e));
        throw e;
      });
  }

  function getFilteredRowsFromCache(){
    var phoneNeedle = (el.fPhone.value || '').trim();
    var nameNeedle  = (el.fName.value  || '').trim();
    var f = (el.fFrom.value || '').trim();
    var t = (el.fTo.value   || '').trim();

    var fromTime = isYL(f) ? (f + '-00.00.00') : null;
    var toTime   = isYL(t) ? (t + '-23.59.59') : null;

    var pnLow = phoneNeedle ? phoneNeedle.toLowerCase() : '';
    var nnLow = nameNeedle  ? nameNeedle.toLowerCase()  : '';

    var out = [];
    (CACHE.allRows || []).forEach(function(r){
      if (r && r._forceRisk){ out.push(r); return; }

      if (pnLow && String(r.phone || '').toLowerCase().indexOf(pnLow) === -1) return;
      if (nnLow && String(r.name  || '').toLowerCase().indexOf(nnLow) === -1) return;
      if (fromTime && String(r.time_key||'') < fromTime) return;
      if (toTime   && String(r.time_key||'') > toTime)   return;

      out.push(r);
    });

    out.sort(function(a,b){
      var ta = String(a.time_key||''), tb = String(b.time_key||'');
      if (ta < tb) return -1;
      if (ta > tb) return 1;
      var pa = String(a.phone||''), pb = String(b.phone||'');
      if (pa < pb) return -1;
      if (pa > pb) return 1;
      return 0;
    });

    return out;
  }

  function rerenderFromCache(){
    if (!CACHE.loaded){
      setStatusOk('הנתונים עדיין לא נטענו. לחץ "טען".');
      return;
    }
    setStatusErr('');
    setStatusOk('מרנדר מקומית…');
    var talkKind = (el.fKind.value || '').trim();
    var rows = getFilteredRowsFromCache();

    ensureUsersInformationForRows(rows).then(function(){
      return render(rows, CACHE.flagsMap, CACHE.infoMap, talkKind);
    }).then(function(info){
      el.countInfo.textContent = 'מציג ' + (info.patientsCount||0) + ' מטופלים · ' + (info.shownCount||0) + ' שיחות פתוחות · ' + (info.hiddenCount||0) + ' שיחות מוסתרות';
      setStatusOk('מוכן.');
    }).catch(function(e){
      setStatusErr('שגיאת רינדור: ' + (e && e.message ? e.message : e));
    });
  }
  var LS_STATUS_KEY = 'uvr_status_filter';
  var STATUS_TITLE_MAP = {
    "":  "כל הסוגים",
    "1": "השיחות של המטפל הוירטואלי",
    "2": "השיחות של מדריך הקורס",
    "3": "השיחות של המטפל הוירטואלי + מדריך הקורס",
    "4": "השיחות של טסט"
  };

  function updateTitlesFromStatus() {
    var kind = (el.fKind && el.fKind.value) ? el.fKind.value : "";
    var fullTitle = Object.prototype.hasOwnProperty.call(STATUS_TITLE_MAP, kind) ? STATUS_TITLE_MAP[kind] : "כל הסוגים";
    document.title = fullTitle;
    var h2 = $("pageTitle");
    if (h2) h2.textContent = fullTitle;
  }

  try {
    if (window.localStorage) {
      var savedStatus = localStorage.getItem(LS_STATUS_KEY);
      if (savedStatus !== null) el.fKind.value = savedStatus;
    }
  } catch(e) {}

  var LIMIT = 100;

  function isYL(s){ return /^\d{4}\.\d{2}\.\d{2}$/.test(s||''); }

  function todayYMD(){
    // מתאים ל-<input type="date"> (YYYY-MM-DD)
    try{
      var d = new Date();
      var y = d.getFullYear();
      var m = String(d.getMonth()+1).padStart(2,'0');
      var day = String(d.getDate()).padStart(2,'0');
      return y + '-' + m + '-' + day;
    }catch(e){
      return '';
    }
  }

  // תווית למצב משתמש (מטפל/מדריך) שמגיע מ-users_information.status
  function statusLabel(statusVal){
    if (statusVal == null) return 'לא ידוע';
    var s = String(statusVal).trim();
    if (!s) return 'לא ידוע';

    // התאמות נפוצות (שמור גמיש - לא מניח קידוד יחיד)
    var low = s.toLowerCase();
    if (s === '1' || low === 'therapist' || low === 't') return 'מטפל וירטואלי';
    if (s === '3' || low === 'mentor'    || low === 'm') return 'מדריך קורס';

    // אם כבר הגיע בעברית - נשאיר בקירוב תקין
    if (s.indexOf('מטפל') !== -1)  return 'מטפל וירטואלי';
    if (s.indexOf('מדריך') !== -1) return 'מדריך קורס';

    return s;
  }

function stripAllHtml(raw){
    var s = String(raw==null?'':raw);
    s = s.replace(/<br\s*\/?>(?=\s*)/gi, '\n');
    s = s.replace(/<\/?.*?>/g, '');
    return s;
  }
  function normalizeWs(raw){
    return String(raw==null?'':raw)
      .replace(/[\u200e\u200f\u202a-\u202e\u200b]/g,'')
      .replace(/\u00a0/g,' ')
      .replace(/\r/g,'')
      .replace(/[ \t]+\n/g, '\n')
      .replace(/\n{2,}/g, '\n');
  }
  function cleanTalk(raw){ return normalizeWs(stripAllHtml(raw)); }

  function b64Enc(str){ try{ return btoa(unescape(encodeURIComponent(String(str||'')))); }catch(e){ return ''; } }
  function b64Dec(str){ try{ return decodeURIComponent(escape(atob(String(str||'')))); }catch(e){ return ''; } }

  function sliceSummaryFromLastMarker(summary){
    var s = String(summary||'');
    if (!s) return s;
    var lines = s.split(/\n/);
    var lastIdx = -1;
    var rx = /^\s*(\d{2}\/\d{2}\/\d{4})\s*-\s*(\d{8}T\d{6}Z)\s*$/;
    for (var i=0;i<lines.length;i++){
      if (rx.test(lines[i])) lastIdx = i;
    }
    if (lastIdx === -1) return s;
    return lines.slice(lastIdx).join('\n');
  }

  function timeKeyToHuman(k){
    var s = String(k||'');
    var parts = s.split('-');
    if (parts.length === 2){
      var d = parts[0];
      var hhmmssms = parts[1].replace(/\./g, ':');
      return hhmmssms + '  ' + d;
    }
    return s;
  }

  function escapeRegExp(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  function ilStamp(ts){
    try{ return new Date(ts).toLocaleString('he-IL', { timeZone: 'Asia/Jerusalem', hour12: false }); }
    catch(e){ return ts; }
  }
  function nowISO(){ return new Date().toISOString(); }
  function normPhone(p){
    var s = String(p == null ? '' : p);
    // keep digits only
    var d = s.replace(/\D+/g,'');
    if (!d) return s.trim();

    // normalize Israel +972XXXXXXXXX -> 0XXXXXXXXX when possible
    if (d.startsWith('972') && d.length >= 11){
      var rest = d.slice(3);
      if (rest.length === 9) return '0' + rest;
      if (rest.length === 10 && rest.startsWith('0')) return rest;
      return rest;
    }

    // normalize Israel numbers missing leading 0 (e.g. 526010111 -> 0526010111)
    if (d.length === 9){
      return '0' + d;
    }

    return d;
  }

function keyOf(time_key, phone){ return String(time_key||'') + '|' + normPhone(phone); }

  
  function keyOfId(id){ return String(id||''); }
function showInlineMsg(talkElem, msg){
    if (!talkElem) return;
    var box = talkElem.querySelector('.inline-msg');
    if (!box){
      box = document.createElement('div');
      box.className = 'inline-msg';
      var head = talkElem.querySelector('.head');
      if (head && head.nextSibling) talkElem.insertBefore(box, head.nextSibling);
      else talkElem.appendChild(box);
    }
    box.textContent = msg;
  }

  function showInlineMsgNearRiskBox(riskBox, msg){
    if (!riskBox) return;
    var box = riskBox.querySelector('.rc-inline-msg');
    if (!box){
      box = document.createElement('div');
      box.className = 'rc-inline-msg';
      // place it right after the textarea block (or at end of the risk-controls box)
      var ta = riskBox.querySelector('textarea[data-act="risk-note"]');
      if (ta && ta.parentNode){
        var parent = ta.parentNode;
        // try to insert after the textarea's container
        if (parent.nextSibling) parent.parentNode.insertBefore(box, parent.nextSibling);
        else riskBox.appendChild(box);
      } else {
        riskBox.appendChild(box);
      }
    }
    box.textContent = msg;
  }

  function clearInlineMsgNearRiskBox(riskBox){
    try{
      var box = riskBox ? riskBox.querySelector('.rc-inline-msg') : null;
      if (box) box.remove();
    }catch(e){}
  }


  // -------------------------------
  // דיאלוג לפורמטים שונים (שם מטופל/ת, "המטפל:", Q/A, וכו')
  // -------------------------------
  function toDialogLines(name, rawText){
    var patient = (name && String(name).trim()) ? String(name).trim() : 'מטופל/ת';

    var tsPrefix = '\\s*(?:\\[[^\\]]*\\]\\s*)?';
    var rxPatientName = new RegExp('^' + tsPrefix + escapeRegExp(patient) + ':\\s*');
    var rxTher = new RegExp('^' + tsPrefix + 'המטפל:\\s*');
    var rxQ = new RegExp('^' + tsPrefix + 'Q:\\s*', 'i');
    var rxA = new RegExp('^' + tsPrefix + 'A:\\s*', 'i');
    var rxGenericPatient = new RegExp('^' + tsPrefix + '(?:המטופל|מטופל\\/ת|מטופל):\\s*');
    var rxGenericTher = new RegExp('^' + tsPrefix + '(?:המטפל):\\s*');

    var lines = String(rawText||'').split(/\n/);
    var out = [];

    for (var i=0;i<lines.length;i++){
      var s0 = String(lines[i]||'');

      // Preserve original line number prefix like: "-1- Q: ..." / "-2- A: ..."
      // This number is used for anchoring to risk_reviews.line_num / risk_reviews.page_num.
      var lnNum = null;
      var mNum = /^\s*-\s*(\d+)\s*-\s*(.*)$/.exec(s0);
      var s = s0;
      var numPrefix = '';
      if (mNum){
        lnNum = parseInt(mNum[1], 10);
        if (!isFinite(lnNum) || lnNum < 1){ lnNum = null; }
        s = String(mNum[2]||'');
      }

      if (rxPatientName.test(s)){ out.push({ speaker:'patient', body: s.replace(rxPatientName,''), _lineNum: lnNum }); continue; }
      if (rxTher.test(s)){ out.push({ speaker:'therapist', body: s.replace(rxTher,''), _lineNum: lnNum }); out.push({ speaker:'spacer' }); continue; }
      if (rxQ.test(s)){ out.push({ speaker:'patient', body: s.replace(rxQ,''), _lineNum: lnNum }); continue; }
      if (rxA.test(s)){ out.push({ speaker:'therapist', body: s.replace(rxA,''), _lineNum: lnNum }); out.push({ speaker:'spacer' }); continue; }
      if (rxGenericPatient.test(s)){ out.push({ speaker:'patient', body: s.replace(rxGenericPatient,''), _lineNum: lnNum }); continue; }
      if (rxGenericTher.test(s)){ out.push({ speaker:'therapist', body: s.replace(rxGenericTher,''), _lineNum: lnNum }); out.push({ speaker:'spacer' }); continue; }

      if (/^\s*שאלה:\s*/.test(s)){ out.push({ speaker:'patient', body: s.replace(/^\s*שאלה:\s*/,''), _lineNum: lnNum }); continue; }
      if (/^\s*תשובה:\s*/.test(s)){ out.push({ speaker:'therapist', body: s.replace(/^\s*תשובה:\s*/,''), _lineNum: lnNum }); out.push({ speaker:'spacer' }); continue; }

      out.push({ speaker:'text', body: s, _lineNum: lnNum });
    }
    return { patient: patient, lines: out };
  }

  // -------------------------------
  // RISK: מגיע רק מ-risk_reviews (בלי Regex)
  // -------------------------------
  
  function loadRiskRows(talk_id){
    if (!talk_id) return Promise.resolve([]);
    if (CACHE && CACHE.loaded){
      return Promise.resolve(CACHE.riskMap.get(String(talk_id)) || []);
    }
    return supa.from(REVIEWS_TABLE)
      // NOTE: production schema uses LINE_NUM (no page_num)
      .select('id, time_key, phone, line_num, status, reviewed_at, reviewer, name, review_notes, severity, match_method, risk_reasons, short_risk')
      .eq('id', talk_id)
      .then(function(res){
        if (res.error) return [];
        return res.data || [];
      });
  }


  // ------------------------------------------------------------
  // RISK REVIEW UI: update status / notes (Hebrew statuses)
  // ------------------------------------------------------------
  function updateRiskReviewStatus(talkId, lineNum, newStatus, notes){
    var stUi = String(newStatus || '').trim();
    if (!talkId || !lineNum || !stUi) return Promise.resolve(false);
    var txt = (notes == null) ? '' : String(notes);

    // Map UI labels to DB statuses
    var stDb = stUi;
    if (stUi === 'צפיתי') stDb = 'VIEWED';
    if (stUi === 'מבטל סיכון') stDb = 'risk is deleted';

    return supa.from(REVIEWS_TABLE)
      .update({ status: stDb, review_notes: txt, reviewed_at: nowISO(), reviewer: 'viewer' })
      .eq('id', talkId)
      .eq('line_num', lineNum)
      .select('id')
      .then(function(res){
        if (res && res.error) throw res.error;
        var updated = (res && res.data) ? res.data : [];
        if (updated && updated.length) return true;
        return false;
      })
      .then(function(ok){
        if (ok && CACHE && CACHE.loaded){
          var arr = CACHE.riskMap.get(String(talkId)) || [];
          for (var i=0;i<arr.length;i++){
            var rr = arr[i];
            var ln = (rr && rr.line_num);
            if (parseInt(ln,10) === parseInt(lineNum,10)){
              rr.status = stDb;
              rr.review_notes = txt;
              rr.reviewed_at = nowISO();
              rr.reviewer = 'viewer';
            }
          }
        }
        return ok;
      });
  }

  function updateRiskReviewNotes(talkId, lineNum, notes){
    if (!talkId || !lineNum) return Promise.resolve(false);
    var txt = (notes == null) ? '' : String(notes);

    return supa.from(REVIEWS_TABLE)
      .update({ review_notes: txt, reviewed_at: nowISO(), reviewer: 'viewer' })
      .eq('id', talkId)
      .eq('line_num', lineNum)
      .select('id')
      .then(function(res){
        if (res && res.error) throw res.error;
        var updated = (res && res.data) ? res.data : [];
        if (updated && updated.length) return true;
        return false;
      })
      .then(function(ok){
        if (ok && CACHE && CACHE.loaded){
          var arr = CACHE.riskMap.get(String(talkId)) || [];
          for (var i=0;i<arr.length;i++){
            var rr = arr[i];
            var ln = (rr && rr.line_num);
            if (parseInt(ln,10) === parseInt(lineNum,10)){
              rr.review_notes = txt;
              rr.reviewed_at = nowISO();
              rr.reviewer = 'viewer';
            }
          }
        }
        return ok;
      });
  }

  
  function snippetAround(full, match){
    var s = String(full||''), m = String(match||'');
    if (!m) return s.slice(0, 60);
    var idx = s.indexOf(m);
    if (idx === -1) return (m.length>80? m.slice(0,80)+'…' : m);
    var start = Math.max(0, idx - 18), end = Math.min(s.length, idx + m.length + 18);
    return (start>0?'…':'') + s.slice(start, end).trim() + (end<s.length?'…':'');
  }

  function hashStr(str){
    var h=5381, i=0, cc;
    for (i=0;i<str.length;i++){ cc=str.charCodeAt(i); h=((h<<5)+h) ^ cc; }
    return (h>>>0).toString(16);
  }

  // מנסים לעגן כל RISK בתוך שורת מטופל כדי לאפשר "פתח את הסיכון"
  
  
  function bindRiskToDialog(dialogLines, talkDomId, riskRows){
    // line_num is 1-based as stored in risk_reviews.
    var hits = [];
    (riskRows || []).forEach(function(rr){
      // Production schema uses LINE_NUM
      var rawLn = (rr && rr.line_num);
      var ln = rawLn != null ? parseInt(rawLn, 10) : NaN;
      if (!isFinite(ln) || ln < 1) ln = -1;

      hits.push({
        id: rr.id || null,
        time_key: rr.time_key || '',
        phone: rr.phone || '',
        line_num: ln,
        targetId: (ln >= 1 ? ('ln-' + talkDomId + '-' + ln) : ''),
        status: rr.status || 'NEW',
        reviewed_at: rr.reviewed_at || null,
        reviewer: rr.reviewer || '',
        short_risk: rr.short_risk || '',
        risk_reasons: rr.risk_reasons || '',
        review_notes: (rr.review_notes != null ? String(rr.review_notes) : '')
      });
    });
    return hits;
  }

  function applyAnchorsToDialogLines(dialogLines, talkDomId){
    if (!dialogLines || !dialogLines.length) return;
    for (var i=0;i<dialogLines.length;i++){
      var ln = dialogLines[i];
      if (!ln) continue;
      var n = ln._lineNum != null ? parseInt(ln._lineNum, 10) : NaN;
      if (isFinite(n) && n >= 1){
        ln._anchorId = 'ln-' + talkDomId + '-' + n;
      }
    }
  }


  function renderDialogHtml(patientName, dialogLines, hits){
    var html = [];

    function normStatus(st){
      var s = String(st || '').trim();
      // legacy compatibility: CHECKED behaved like a 'viewed' open risk
      if (s === 'CHECKED') return 'VIEWED';
      return s || 'NEW';
    }

    function isOpenRiskStatus(st){
      var s = normStatus(st);
      return (s === 'NEW' || s === 'VIEWED');
    }

    function isDeletedRiskStatus(st){
      var s = normStatus(st);
      return (s === 'risk is deleted');
    }

    // Map line_num -> hit (prefer open over deleted if multiple)
    var hitByLine = new Map();
    (hits || []).forEach(function(h){
      var ln = parseInt(h.line_num, 10);
      if (!isFinite(ln) || ln < 1) return;
      var prev = hitByLine.get(ln);
      if (!prev){
        hitByLine.set(ln, h);
        return;
      }
      // prefer open status over deleted if duplicates exist
      if (isDeletedRiskStatus(prev.status) && isOpenRiskStatus(h.status)) hitByLine.set(ln, h);
    });

    function lineAttrs(lnObj){
      var attrs = '';
      var cls = 'line speaker';
      var n = (lnObj && lnObj._lineNum != null) ? parseInt(lnObj._lineNum, 10) : NaN;
      var hit = (isFinite(n) && n >= 1) ? hitByLine.get(n) : null;

      if (lnObj && lnObj._anchorId){
        attrs += ' id="' + escapeHtml(lnObj._anchorId) + '"';
      }
      if (hit){
        var st = normStatus(hit.status);
        if (isDeletedRiskStatus(st)) cls += ' risk-line checked';
        else cls += ' risk-line open';
        attrs += ' data-risk="1"';
        attrs += ' data-risk-id="' + escapeHtml(String(hit.id||'')) + '"';
        attrs += ' data-risk-ln="' + escapeHtml(String(n)) + '"';
      }
      attrs += ' class="' + cls + '"';
      return { attrs: attrs, hit: hit, lineNum: n };
    }

    function badgeForHit(hit){
      if (!hit) return '';
      var stDb = normStatus(hit.status);
      var label = 'RISK';
      var cls = 'open';
      if (stDb === 'VIEWED') { label = 'צפיתי'; cls = 'open'; }
      if (stDb === 'risk is deleted') { label = 'מבטל סיכון'; cls = 'checked'; }
      return ' <span class="risk-badge ' + cls + '">' + escapeHtml(label) + '</span>';
    }

    function controlsForHit(talkId, lineNum, hit){
      if (!hit) return '';
      var stDb = normStatus(hit.status || 'NEW');
      var stUi = (stDb === 'VIEWED') ? 'צפיתי' : ((stDb === 'risk is deleted') ? 'מבטל סיכון' : 'NEW');
      var notes = (hit.review_notes != null ? String(hit.review_notes) : '').trim();

      var btnSeenCls = (stUi === 'צפיתי') ? ' rc-btn active' : ' rc-btn';
      var btnCancelCls = (stUi === 'מבטל סיכון') ? ' rc-btn active' : ' rc-btn';

      var statusLine = '';
      if ((stUi && stUi !== 'NEW') || notes){
        var stShow = stUi && stUi !== 'NEW' ? stUi : '';
        statusLine = '<div class="rc-small">' +
          (stShow ? ('סטטוס: <span class="rc-status">' + escapeHtml(stShow) + '</span>') : '') +
          (notes ? (' · הערה: ' + escapeHtml(notes)) : '') +
        '</div>';
      }

      return (
        '<div class="risk-controls" data-riskctl="1" data-id="' + escapeHtml(String(talkId||'')) + '" data-ln="' + escapeHtml(String(lineNum)) + '">' +
          '<div class="rc-row">' +
            '<span class="rc-title">אישור מטפל:</span>' +
            '<button class="' + btnSeenCls + '" data-act="risk-status" data-status="צפיתי">צפיתי</button>' +
            '<button class="' + btnCancelCls + '" data-act="risk-status" data-status="מבטל סיכון">מבטל סיכון</button>' +
          '</div>' +
          '<div style="margin-top:8px"><label class="hint">הערת מטפל:</label>' +
          '<textarea data-act="risk-note" placeholder="הקלד הערה...">' + escapeHtml(notes) + '</textarea>' +
          '<div style="margin-top:8px"><button class="rc-btn" data-act="risk-note-save">שמור הערה</button></div></div>' +
          statusLine +
        '</div>'
      );
    }

    for (var i=0;i<dialogLines.length;i++){
      var ln = dialogLines[i];
      if (!ln) continue;

      if (ln.speaker === 'spacer'){
        html.push('<div class="line-spacer"></div>');
        continue;
      }

      var la = lineAttrs(ln);
      var badge = badgeForHit(la.hit);

      if (ln.speaker === 'patient'){
        html.push('<div' + la.attrs + '><span class="speaker speaker-patient">' + escapeHtml(patientName) + ':</span> ' + escapeHtml(ln.body || '') + badge + '</div>');
      } else if (ln.speaker === 'therapist'){
        html.push('<div' + la.attrs + '><span class="speaker speaker-therapist">המטפל:</span> ' + escapeHtml(ln.body || '') + badge + '</div>');
      } else {
        html.push('<div' + la.attrs + '>' + escapeHtml(ln.body || '') + badge + '</div>');
      }

      if (la.hit){
        html.push(controlsForHit(la.hit.id, la.lineNum, la.hit));
      }
    }

    return html.join('\n');
  }


  function queryPage(forceReload){
    // בטעינה הראשונית: מביאים את הכל ללא סלקציה.
    // לאחר מכן: סלקציות מקומיות בלבד (ללא רשת).
    if (CACHE.loaded && !forceReload){
      rerenderFromCache();
      return;
    }
    loadAllDataFromServer().then(function(){
      rerenderFromCache();
    }).catch(function(){});
  }



  function render(rows, flagsMap, infoMap, talkKind){
    return new Promise(function(resolve){
      var parts = [], alerts = [];
      var hiddenCount = 0, shownCount = 0;
      var patientsShown = new Set();

      function isRowAllowed(row){
        // Default: no override.
        if (row) row._riskOverrideKind = false;

        // No status filter selected
        if (!talkKind) return true;

        var phoneKey = normPhone(row.phone);
        if (!phoneKey) return false;

        var info = infoMap.get(phoneKey);
        if (!info || info.status == null) return false;

        var sVal = parseInt(info.status, 10);
        var kVal = parseInt(talkKind, 10);
        if (!isFinite(kVal)) return true;

        var allowed = (sVal === kVal);
        if (allowed) return true;

        // If not allowed by status, still allow when talk has risk -> mark as override
        if (row && row._hasRisk){
          row._riskOverrideKind = true;
          return true;
        }
        return false;
      }

      function nextRow(i){
        if (i >= rows.length){
          var totalHits = alerts.reduce(function(sum, a){ return sum + (a.items ? a.items.length : 0); }, 0);

          el.out.innerHTML = parts.join('') || '<div class="card hint">אין תוצאות.</div>';

          if (alerts.length){
            var top = ['<div class="alertbar"><h3>⚠️ נמצאו ' + totalHits + ' ביטויי סיכון ב-' + alerts.length + ' שיחות</h3>'];
            for (var a=0;a<alerts.length;a++){
              var AA = alerts[a];
              top.push('<div class="alertitem">');
              top.push('<div><strong>' + escapeHtml(AA.name) + '</strong> · ' + escapeHtml(AA.phone) + '</div>');
              top.push('<div class="when">' + escapeHtml(AA.time) + '</div><div>');
              for (var z=0; z<AA.items.length; z++){
                var it = AA.items[z];
                top.push('<span class="pill mono" title="' + escapeHtml(it.text) +'">'+ escapeHtml(it.text) +'</span> ');
                if (it.targetId){
                  top.push('<button class="btn-open-risk" data-act="goto" data-target="' + escapeHtml(it.targetId) + '">פתח את הסיכון</button> ');
                } else {
                  top.push('<button class="btn-open-risk" disabled title="לא נמצא עוגן בטקסט">פתח את הסיכון</button> ');
                }
              }
              top.push('</div></div>');
            }
            top.push('</div>');
            el.alertHost.innerHTML = top.join('');
            el.alertHost.querySelectorAll('button[data-act="goto"]').forEach(function(btn){
              btn.addEventListener('click', function(){
                var id = btn.getAttribute('data-target');
                var node = id ? document.getElementById(id) : null;
                if (!node) return;

                // remove previous selection
                document.querySelectorAll('.risk-selected').forEach(function(n){ n.classList.remove('risk-selected'); });

                node.scrollIntoView({behavior:'smooth', block:'center'});
                node.classList.add('risk-selected');
                node.classList.add('target-blink');
                setTimeout(function(){ node.classList.remove('target-blink'); }, 1300);
              });
            });
          } else {
            el.alertHost.innerHTML = '';
          }

          resolve({ hiddenCount:hiddenCount, shownCount:shownCount, patientsCount: patientsShown.size });
          return;
        }

        var r = rows[i];
        if (!isRowAllowed(r)){ nextRow(i+1); return; }

        var talkClean = cleanTalk(r.last_talk_tzvira || '');
        var parsed = toDialogLines(r.name, talkClean);
        var talkDomId = (r.time_key || '').replace(/[^0-9]/g,'') || Math.random().toString(36).slice(2);

        // Anchor IDs are based on the original line numbers ("-1-", "-2-", ...)
        applyAnchorsToDialogLines(parsed.lines, talkDomId);

        loadRiskRows(r.id).then(function(riskRows){
          var hits = bindRiskToDialog(parsed.lines, talkDomId, riskRows);

          // open risks for alerts: status NEW or VIEWED (legacy CHECKED treated as VIEWED)
          var notRev = [];
          for (var h=0; h<hits.length; h++){
            var st = String(hits[h].status || 'NEW').trim();
            if (st === 'CHECKED') st = 'VIEWED';
            if (st === 'NEW' || st === 'VIEWED') notRev.push(hits[h]);
          }

          var k = keyOf(r.time_key, r.phone);
          var flag = flagsMap.get(k);
          var isHidden = !!(flag && flag.is_hidden);

          if (!isHidden && notRev.length){
            var items = [];
            for (var nn=0; nn<notRev.length; nn++){
              var hh2 = notRev[nn];
              items.push({
                text: (hh2.risk_reasons || hh2.short_risk || ('line ' + hh2.line_num)),
                targetId: hh2.targetId || ''
              });
            }
            alerts.push({
              name: r.name || 'מטופל/ת',
              phone: r.phone || '',
              time: timeKeyToHuman(r.time_key),
              items: items
            });
          }

          var nameHtml  = '<span class="patient-name">' + escapeHtml(r.name || 'מטופל/ת') + '</span>';
          var phoneHtml = '<span class="patient-phone">' + escapeHtml(r.phone || '') + '</span>';
          var btnLabel  = isHidden ? 'הצג שיחה' : 'הסתר שיחה';

          var rawHasContent = !!(r.summarized_linked_talk && String(r.summarized_linked_talk).trim());

          var headParts = [];
          headParts.push('<div class="head">');
          headParts.push('<div class="head-name">', nameHtml, '</div>');
          headParts.push('<div class="head-phone">', phoneHtml, '</div>');
                              // למה השיחה נבחרה: (א) RISK override אם יש RISK, (ב) סוג שיחה לפי users_information.status,
          // ואם אין מידע—נשתמש בסוג שנבחר בסלקציה הנוכחית (fKind) כ־fallback.
          var kindTxt = 'לא ידוע';
          try{
            var info2 = infoMap.get(normPhone(r.phone));
            if (info2 && info2.status != null && String(info2.status).trim() !== ''){
              kindTxt = statusLabel(info2.status);
            } else {
              var fk = (el && el.fKind ? String(el.fKind.value||'').trim() : '');
              if (fk && fk !== 'all'){
                kindTxt = statusLabel(fk);
              }
            }
          } catch(e){}
          /* kind override exists (row._riskOverrideKind) but we no longer prefix UI with 'RISK override'. */
          headParts.push('<div class="meta why">', escapeHtml(kindTxt), '</div>');

          // Show risk title pill
          // - If there is at least one risk with status NEW or VIEWED (legacy CHECKED treated as VIEWED) => "נמצא גורם סיכון"
          // - If all risks are deleted => "גורם סיכון טופל"
          if (hits && hits.length){
            var allCanceled = true;
            for (var rc=0; rc<hits.length; rc++){
              var st = String(hits[rc].status || 'NEW').trim();
              if (st === 'CHECKED') st = 'VIEWED';
              if (st !== 'risk is deleted'){
                allCanceled = false;
                break;
              }
            }
            var pillTxt = allCanceled ? 'גורם סיכון טופל' : 'נמצא גורם סיכון';
            headParts.push('<div class="meta"><span class="pill">' + escapeHtml(pillTxt) + '</span></div>');
          }

          var canToggle = (isHidden || (!isHidden && notRev.length === 0));
          var canSumm   = (!isHidden && notRev.length === 0);
          var canRaw    = (!isHidden && rawHasContent);

          if (canToggle) {
            headParts.push(
              '<button class="btn-toggle btn-state-active" data-time="', escapeHtml(r.time_key),
              '" data-phone="', escapeHtml(r.phone||''),
              '" data-name="', escapeHtml(r.name||''),
              '" data-hidden="', (isHidden?'1':'0'),
              '" data-notrev="', (notRev.length), '">', btnLabel, '</button>'
            );
          } else {
            headParts.push('<button class="btn-placeholder">' + btnLabel + '</button>');
          }

          if (canSumm) {
            headParts.push('<button class="btn-summarized_linked_talk btn-state-active" data-notrev="0">הצג מקוצרת</button>');
          } else {
            headParts.push('<button class="btn-placeholder">הצג מקוצרת</button>');
          }

          if (canRaw) {
            headParts.push('<button class="btn-raw-summary btn-state-active" title="הצג את summarized_linked_talk כפי שהוא">הצג שיחות קודמות</button>');
          } else {
            headParts.push('<button class="btn-placeholder">הצג שיחות קודמות</button>');
          }

          headParts.push('<span class="meta mono">', escapeHtml(timeKeyToHuman(r.time_key)), '</span>');
          headParts.push('<button class="btn-home" title="חזרה למסך הראשון">חזרה למסך הראשון</button>');
          headParts.push('</div>');

          parts.push('<div class="talk" data-id="' + escapeHtml(r.id||'') + '" data-time_key="' + escapeHtml(r.time_key||'') + '" data-time="' + escapeHtml(r.time_key||'') + '" data-phone="' + escapeHtml(r.phone||'') + '" data-name="'+escapeHtml(r.name||'')+'">');
          parts.push(headParts.join(''));

          if (isHidden){
            hiddenCount++;
          } else {
            shownCount++;
            if (r.phone) patientsShown.add(String(r.phone).trim());

            var dialogHtml = renderDialogHtml(parsed.patient, parsed.lines, hits);
            dialogHtml = dialogHtml.replace(/__TALKDOM__-/g, 'ln-' + talkDomId + '-');
            parts.push('<div class="body">' + dialogHtml + '</div>');

            var sumRaw = (r.summarized_linked_talk || '').trim();
            var sumCut = sliceSummaryFromLastMarker(sumRaw);
            var sumHtml = sumCut ? escapeHtml(sumCut) : '<span class="empty">אין סיכום שיחה.</span>';
            var sumRawB64 = b64Enc(sumRaw);
            parts.push('<div class="summarized_linked_talk" data-raw-b64="'+escapeHtml(sumRawB64)+'">'+ sumHtml +'</div>');
          }

          parts.push('</div>');
          nextRow(i+1);
        });
      }

      nextRow(0);
    });
  }

  // האזנות על רשימת התוצאות
  el.out.addEventListener('click', function(ev){
    var btnHome = ev.target.closest('.btn-home');
    if (btnHome){
      el.fPhone.value=''; el.fName.value=''; el.fFrom.value=''; el.fTo.value='';
      queryPage(true);
      window.scrollTo({top:0, behavior:'smooth'});
      return;
    }

    var btnToggle = ev.target.closest('.btn-toggle');
    if (btnToggle){
      var talkElem = btnToggle.closest('.talk');
      var time_key = btnToggle.getAttribute('data-time');
      var phone    = btnToggle.getAttribute('data-phone');
      var name     = btnToggle.getAttribute('data-name') || null;
      var isHidden = btnToggle.getAttribute('data-hidden') === '1';
      var notRevCount = parseInt(btnToggle.getAttribute('data-notrev')||'0',10);

      if (!isHidden && notRevCount > 0){
        showInlineMsg(talkElem, 'לא ניתן להסתיר שיחה כל עוד קיימים ביטויי סיכון שלא טופלו.');
        return;
      }

      var payload = { time_key: time_key, phone: phone, is_hidden: !isHidden, toggled_by: 'viewer_default', patient_name: name };

      supa.from(FLAGS_TABLE)
          .upsert(payload, { onConflict: 'time_key,phone' })
          .then(function(res2){
            if (res2.error){
              showInlineMsg(talkElem, 'שגיאה בעדכון מצב השיחה: ' + (res2.error.message || 'unknown'));
              return;
            }
            if (CACHE && CACHE.loaded){
              CACHE.flagsMap.set(keyOf(time_key, phone), { is_hidden: !isHidden });
              rerenderFromCache();
            } else {
              queryPage(true);
            }
          });
      return;
    }

    var btnSumm = ev.target.closest('.btn-summarized_linked_talk');
    if (btnSumm){
      var talk = btnSumm.closest('.talk');
      var body = talk.querySelector('.body');
      var sum  = talk.querySelector('.summarized_linked_talk');
      if (body && sum){
        var showingFull = (body.style.display !== 'none');
        if (showingFull){
          body.style.display = 'none';
          sum.style.display  = 'block';
          btnSumm.textContent = 'הצג מלאה';
          btnSumm.classList.add('btn-selected');
        } else {
          sum.style.display  = 'none';
          body.style.display = 'block';
          btnSumm.textContent = 'הצג מקוצרת';
          btnSumm.classList.remove('btn-selected');
        }
      }
      return;
    }

    var btnRaw = ev.target.closest('.btn-raw-summary');
    if (btnRaw){
      var talk2 = btnRaw.closest('.talk');
      var body2 = talk2.querySelector('.body');
      var sum2  = talk2.querySelector('.summarized_linked_talk');
      if (!sum2) return;

      var showingRaw = btnRaw.getAttribute('data-showing') === '1';
      if (!showingRaw){
        var rawB64 = sum2.getAttribute('data-raw-b64') || '';
        var rawTxt = b64Dec(rawB64);
        if (!rawTxt){ showInlineMsg(talk2, 'אין תוכן סיכום שיחות'); return; }

        if (body2) body2.style.display = 'none';
        sum2.style.display = 'block';
        sum2.textContent   = rawTxt;
        btnRaw.textContent = 'הצג שיחה';
        btnRaw.setAttribute('data-showing','1');
        btnRaw.classList.add('btn-selected');
      } else {
        if (sum2)  sum2.style.display  = 'none';
        if (body2) body2.style.display = 'block';
        btnRaw.textContent = 'הצג שיחות קודמות';
        btnRaw.setAttribute('data-showing','0');
        btnRaw.classList.remove('btn-selected');
      }
      return;
    }



    // Inline risk controls: save note button
    var btnRiskNoteSave = ev.target.closest('button[data-act="risk-note-save"]');
    if (btnRiskNoteSave){
      var boxN = btnRiskNoteSave.closest('.risk-controls');
      var talkIdN = boxN ? boxN.getAttribute('data-id') : null;
      var lnN = boxN ? parseInt(boxN.getAttribute('data-ln')||'0',10) : 0;
      var taN = boxN ? boxN.querySelector('textarea[data-act="risk-note"]') : null;
      var txtN = taN ? (taN.value || '') : '';
      var talkElemN = btnRiskNoteSave.closest('.talk');

      updateRiskReviewNotes(talkIdN, lnN, txtN).then(function(ok){
        if (!ok){
          showInlineMsgNearRiskBox(boxN, 'לא עודכנה הערה (לא נמצאה שורה מתאימה).');
          return;
        }
        // visual feedback
        btnRiskNoteSave.textContent = 'נשמר ✔';
        setTimeout(function(){ try{ btnRiskNoteSave.textContent = 'שמור הערה'; }catch(e){} }, 1200);
        if (CACHE && CACHE.loaded){ rerenderFromCache(); } else { queryPage(true); }
      }).catch(function(e){
        showInlineMsgNearRiskBox(boxN, 'שגיאה בעדכון הערה: ' + (e && e.message ? e.message : e));
      });
      return;
    }

    // Inline risk controls: status buttons
    var btnRiskStatus = ev.target.closest('button[data-act="risk-status"]');
    if (btnRiskStatus){
      var box = btnRiskStatus.closest('.risk-controls');
      var talkId = box ? box.getAttribute('data-id') : null;
      var ln = box ? parseInt(box.getAttribute('data-ln')||'0',10) : 0;
      var newStatus = btnRiskStatus.getAttribute('data-status') || '';
      var talkElemX = btnRiskStatus.closest('.talk');

      // Require explanation note (min 10 chars) for both actions
      var taReq = box ? box.querySelector('textarea[data-act="risk-note"]') : null;
      var noteTxt = taReq ? String(taReq.value || '').trim() : '';
      if (noteTxt.length < 10){
        clearInlineMsgNearRiskBox(box);
        showInlineMsgNearRiskBox(box, 'חובה לצרף הסבר לאישור');
        try{ if (taReq) taReq.focus(); }catch(e){}
        return;
      }
      clearInlineMsgNearRiskBox(box);

      // optimistic UI: mark selected button
      try{
        if (box){ box.querySelectorAll('button[data-act="risk-status"]').forEach(function(b){ b.classList.remove('active'); }); }
        btnRiskStatus.classList.add('active');
      }catch(e){}

      updateRiskReviewStatus(talkId, ln, newStatus, noteTxt).then(function(ok){
        if (!ok){
          showInlineMsgNearRiskBox(box, 'לא עודכן סטטוס (לא נמצאה שורה מתאימה).');
          return;
        }
        if (CACHE && CACHE.loaded){ rerenderFromCache(); } else { queryPage(true); }
      }).catch(function(e){
        showInlineMsgNearRiskBox(box, 'שגיאה בעדכון סטטוס: ' + (e && e.message ? e.message : e));
      });
      return;
    }

        var btnReview = ev.target.closest('.btn-review-inline');
    if (btnReview){
      var talkElem2 = btnReview.closest('.talk');
      showInlineMsg(talkElem2, 'בגרסה זו: תצוגה בלבד (אין עדכון סטטוס מה-Viewer).');
      return;
    }

    var btnUnreview = ev.target.closest('.btn-unreview-inline');
    if (btnUnreview){
      var talkElem3 = btnUnreview.closest('.talk');
      showInlineMsg(talkElem3, 'בגרסה זו: תצוגה בלבד (אין עדכון סטטוס מה-Viewer).');
      return;
    }

  // Save risk notes on textarea blur (focusout)
  // במכוון: לא שומרים אוטומטית. משתמשים בכפתור "שמור הערה".
  el.out.addEventListener('focusout', function(ev){ return; }, true);


  });

  el.fKind.addEventListener('change', function(){
    try {
      if (window.localStorage) localStorage.setItem(LS_STATUS_KEY, el.fKind.value || '');
    } catch(e) {}
    updateTitlesFromStatus();
    if (CACHE && CACHE.loaded){ rerenderFromCache(); } else { queryPage(true); }
  });

  el.btnRun.onclick   = function(){ queryPage(true); };
  el.btnClear.onclick = function(){
    el.fPhone.value=''; el.fName.value=''; el.fFrom.value=''; el.fTo.value='';
    if (CACHE && CACHE.loaded){ rerenderFromCache(); } else { queryPage(true); }
  };

  updateTitlesFromStatus();


  // Cache-busting badge: show ?v=... near the version label (testing visibility)
  (function(){
    try{
      var sp = new URLSearchParams(window.location.search || "");
      var v = sp.get("v");
      var badge = document.getElementById("vBadge");
      if (badge && v){ badge.textContent = " · v=" + String(v); }
    }catch(e){}
  })();

  // init אחרי שה-DOM מוכן (למקרה של race)
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ queryPage(true); });
  } else {
    queryPage(true);
  }
})();
</script>
</body>
</html>
