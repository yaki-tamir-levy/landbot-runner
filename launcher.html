<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>כניסה לשיחות המטפל הוירטואלי</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.js"></script>
  <style>
    :root {
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --divider:#e5e7eb;
      --danger:#7f1d1d;
      --ok:#065f46;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .card{
      background:var(--card);
      border:1px solid var(--divider);
      border-radius:16px;
      padding:24px 22px 20px;
      max-width:380px;
      width:100%;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    h1{
      margin:0 0 8px 0;
      font-size:1.4rem;
      text-align:center;
    }
    p{
      margin:0 0 16px 0;
      font-size:.9rem;
      color:var(--muted);
      text-align:center;
      line-height:1.45;
    }
    label{
      display:block;
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:4px;
    }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--divider);
      font-size:1rem;
    }
    .readonly{
      background:#f9fafb;
      color:#374151;
    }
    button{
      width:100%;
      margin-top:12px;
      padding:10px 12px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-weight:700;
      background:#4f46e5;
      color:white;
    }
    button.secondary{
      background:#111827;
    }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .err{
      margin-top:10px;
      font-size:.85rem;
      color:var(--danger);
      text-align:center;
      white-space:pre-wrap;
    }
    .ok{
      margin-top:10px;
      font-size:.85rem;
      color:var(--ok);
      text-align:center;
      white-space:pre-wrap;
    }
    .small{
      margin-top:10px;
      font-size:.78rem;
      color:var(--muted);
      text-align:center;
      line-height:1.4;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>כניסה למערכת</h1>
    <p>
      הזדהות באמצעות מספר טלפון קבוע ואימות קוד שנשלח למייל המשויך אליו במערכת.
      <br/>
      <b>אין צורך להזין מייל.</b>
    </p>

    <form id="frmSend" autocomplete="off">
      <label for="phone">מספר טלפון</label>
      <input id="phone" class="readonly" type="text" readonly />
      <button id="btnSend" type="submit">שלח קוד למייל</button>
    </form>

    <form id="frmVerify" autocomplete="off" style="margin-top:14px;">
      <label for="token">קוד (6 ספרות)</label>
      <input id="token" inputmode="numeric" pattern="\\d*" maxlength="6" placeholder="הקלד/י 6 ספרות" />
      <button id="btnVerify" class="secondary" type="submit">אמת קוד</button>
      <div id="msg"></div>
      <div class="small" id="hint"></div>
    </form>
  </div>

  <script>
    (function () {
      "use strict";

      // Supabase project config (must match users_viewer_risk_prod.html)
      var SUPABASE_URL      = "https://qcwimczsiuxkarwfiyai.supabase.co";
      var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjd2ltY3pzaXV4a2Fyd2ZpeWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1OTEwMzgsImV4cCI6MjA2OTE2NzAzOH0.zpMcORTD1voqZFj5QaPUc-EXf1juqnlTTP00jV6_TvI";
      var FIXED_PHONE = "0547558740";

      var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      var frmSend   = document.getElementById("frmSend");
      var frmVerify = document.getElementById("frmVerify");
      var phoneEl   = document.getElementById("phone");
      var tokenEl   = document.getElementById("token");
      var btnSend   = document.getElementById("btnSend");
      var btnVerify = document.getElementById("btnVerify");
      var msg       = document.getElementById("msg");
      var hint      = document.getElementById("hint");

      phoneEl.value = FIXED_PHONE;

      function showMsg(text, ok){
        if (!msg) return;
        msg.textContent = text || "";
        msg.className = ok ? "ok" : "err";
      }

      function setHint(text){
        if (!hint) return;
        hint.textContent = text || "";
      }

      function edgeCall(fnName, body){
        return fetch(SUPABASE_URL + "/functions/v1/" + fnName, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + SUPABASE_ANON_KEY,
            "apikey": SUPABASE_ANON_KEY
          },
          body: JSON.stringify(body || {})
        }).then(async function(res){
          var data = null;
          try { data = await res.json(); } catch(e) {}
          if (!res.ok) {
            var errMsg = (data && (data.error || data.message)) ? (data.error || data.message) : ("HTTP " + res.status);
            throw new Error(errMsg);
          }
          return data;
        });
      }

      function goViewer(){
        // Cache bust to avoid stale deploys
        var v = String(Date.now());
        window.location.href = "users_viewer_risk_prod.html?v=" + encodeURIComponent(v);
      }

      async function init(){
        try{
          var s = await supa.auth.getSession();
          if (s && s.data && s.data.session) {
            goViewer();
            return;
          }
        }catch(e){}
      }
      init();

      var lastSentAt = 0; // client-side cooldown (not a security feature)
      var COOLDOWN_MS = 30 * 1000;

      frmSend.addEventListener("submit", async function(ev){
        ev.preventDefault();
        showMsg("", true);
        setHint("");

        var now = Date.now();
        if (now - lastSentAt < COOLDOWN_MS) {
          var left = Math.ceil((COOLDOWN_MS - (now - lastSentAt)) / 1000);
          showMsg("נא להמתין " + left + " שניות לפני שליחה נוספת.", false);
          return;
        }

        btnSend.disabled = true;
        btnVerify.disabled = true;

        try{
          await edgeCall("start-login", { phone: FIXED_PHONE });
          lastSentAt = Date.now();
          showMsg("אם המספר קיים במערכת, נשלח קוד למייל המשויך אליו.", true);
          setHint("הקלד/י את הקוד שקיבלת במייל (6 ספרות)." );
          tokenEl.focus();
        }catch(e){
          // תשובה כללית גם במקרה שגיאה, כדי לא לחשוף מידע רגיש
          console.warn("start-login error:", e);
          showMsg("אם המספר קיים במערכת, נשלח קוד למייל המשויך אליו.", true);
          setHint("אם לא קיבלת מייל, נסה/י שוב בעוד רגע.");
        }finally{
          btnSend.disabled = false;
          btnVerify.disabled = false;
        }
      });

      async function verifyToken(){
        var token = (tokenEl.value || "").replace(/\\D/g, "").slice(0, 6);
        if (token.length !== 6) {
          showMsg("יש להזין 6 ספרות.", false);
          return;
        }

        btnSend.disabled = true;
        btnVerify.disabled = true;
        showMsg("מאמת קוד...", true);
        setHint("");

        try{
          var out = await edgeCall("verify-login", { phone: FIXED_PHONE, token: token });
          if (!out || !out.access_token || !out.refresh_token) {
            throw new Error("Missing tokens from verify-login");
          }
          await supa.auth.setSession({ access_token: out.access_token, refresh_token: out.refresh_token });
          showMsg("התחברת בהצלחה. מעביר למסך הראשי...", true);
          goViewer();
        }catch(e){
          console.warn("verify-login error:", e);
          showMsg("קוד שגוי או שפג תוקפו. נסה/י שוב או שלח/י קוד מחדש.", false);
          btnSend.disabled = false;
          btnVerify.disabled = false;
          tokenEl.focus();
          tokenEl.select();
        }
      }

      frmVerify.addEventListener("submit", function(ev){
        ev.preventDefault();
        verifyToken();
      });

      tokenEl.addEventListener("input", function(){
        // auto verify when 6 digits entered
        var v = (tokenEl.value || "").replace(/\\D/g, "");
        if (v !== tokenEl.value) tokenEl.value = v;
        if (v.length === 6) verifyToken();
      });

    })();
  </script>
</body>
</html>
