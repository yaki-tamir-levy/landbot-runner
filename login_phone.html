<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>אימות טלפון</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 520px; margin: 40px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .row { margin: 10px 0; }
    input { width: 100%; font-size: 18px; padding: 10px; border-radius: 10px; border: 1px solid #bbb; }
    button { width: 100%; font-size: 18px; padding: 10px; border-radius: 10px; border: 0; cursor: pointer; }
    button.primary { background: #111; color: #fff; }
    .muted { color: #666; font-size: 14px; }
    .ok { color: #0a7; }
    .err { color: #c00; }
    code { background:#f6f6f6; padding:2px 6px; border-radius:6px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="muted">VERSION: <code>2026-01-25-LOGIN-PHONE-RETURNTO-FIX1</code></div>

  <div class="card">
    <div class="row muted">הזן טלפון, נשלח קוד למייל המשויך. לאחר אימות תועבר לאפליקציה.</div>

    <div class="row">
      <label class="muted">טלפון</label>
      <input id="phone" type="tel" placeholder="05xxxxxxxx" />
    </div>

    <div class="row">
      <button id="btnSend" class="primary">שלח קוד</button>
      <div id="sendStatus" class="muted"></div>
    </div>

    <div class="row">
      <label class="muted">קוד (6 ספרות)</label>
      <input id="token" type="text" inputmode="numeric" autocomplete="one-time-code" maxlength="6" placeholder="______" />
      <div id="verifyStatus" class="muted"></div>
    </div>
  </div>

<script>
(() => {
  // ====== חובה לעדכן לערכים האמיתיים שלך (כמו בקובץ שעבד) ======
  const SUPABASE_URL = "https://YOUR_PROJECT.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";

  const FUNCTIONS_BASE = `${SUPABASE_URL}/functions/v1`;

  const qs = new URLSearchParams(location.search);
  const RETURN_TO = qs.get("return_to") || "users_viewer_risk_prod.html";

  const $ = (id) => document.getElementById(id);

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  function setText(el, txt, cls) {
    el.className = cls || "muted";
    el.textContent = txt || "";
  }

  async function postJson(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": "Bearer " + SUPABASE_ANON_KEY
      },
      body: JSON.stringify(body)
    });
    const txt = await res.text();
    let json = null;
    try { json = JSON.parse(txt); } catch {}
    if (!res.ok) {
      const msg = (json && (json.error || json.message)) ? (json.error || json.message) : txt;
      throw new Error(msg || `HTTP ${res.status}`);
    }
    return json || {};
  }

  async function sendCode() {
    $("btnSend").disabled = true;
    setText($("sendStatus"), "שולח קוד…", "muted");
    try {
      await postJson(`${FUNCTIONS_BASE}/start-login`, { phone: $("phone").value });
      setText($("sendStatus"), "אם המספר קיים במערכת — נשלח קוד למייל המשויך.", "ok");
      $("token").focus();
    } catch (e) {
      console.error(e);
      setText($("sendStatus"), "אם המספר קיים במערכת — נשלח קוד למייל המשויך.", "ok");
    } finally {
      $("btnSend").disabled = false;
    }
  }

  async function verifyCode(token) {
    setText($("verifyStatus"), "מאמת…", "muted");
    try {
      const data = await postJson(`${FUNCTIONS_BASE}/verify-login`, {
        phone: $("phone").value,
        token
      });

      if (!data.access_token || !data.refresh_token) {
        throw new Error("Missing tokens");
      }

      const { error } = await supabase.auth.setSession({
        access_token: data.access_token,
        refresh_token: data.refresh_token
      });
      if (error) throw error;

      // אם יש Guard בדף היעד:
      localStorage.setItem("otp_verified", "1");

      setText($("verifyStatus"), "אימות הצליח. נכנס…", "ok");
      location.replace(RETURN_TO);
    } catch (e) {
      console.error(e);
      setText($("verifyStatus"), "קוד שגוי / פג תוקף.", "err");
    }
  }

  $("btnSend").addEventListener("click", sendCode);

  $("token").addEventListener("input", (e) => {
    const digits = (e.target.value || "").replace(/\D/g, "").slice(0, 6);
    e.target.value = digits;
    if (digits.length === 6) verifyCode(digits);
  });
})();
</script>
</body>
</html>
